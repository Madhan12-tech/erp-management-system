<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Duct Entry</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body.dark-mode {
      background-color: #121212;
      color: white;
    }
    .dark-mode .table, .dark-mode input, .dark-mode select {
      color: white;
      background-color: #333;
      border-color: #555;
    }
    th, td {
      text-align: center;
      vertical-align: middle;
    }
    .sticky-total {
      position: sticky;
      bottom: 0;
      background: #e0e0e0;
      z-index: 2;
    }
    @media (max-width: 768px) {
      .row-flex {
        flex-direction: column;
      }
    }
    @media (min-width: 769px) {
      .row-flex {
        display: flex;
        gap: 15px;
      }
    }
    .form-section { flex: 1; min-width: 280px; }
    .table-section { flex: 3; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6>Project: {{ project.vendor_name }} | Location: {{ project.location }} | Status: {{ project.status }}</h6>
      <button class="btn btn-sm btn-secondary" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    </div>

    <div class="row-flex">
      <!-- Duct Entry Form -->
      <div class="form-section">
        <form method="POST" action="{{ url_for('add_duct') }}">
          <input type="hidden" name="project_id" value="{{ project.id }}">
          {% if edit_entry %}<input type="hidden" name="id" value="{{ edit_entry.id }}">{% endif %}

          <div class="mb-2"><label>Duct No</label>
            <input type="text" name="duct_no" class="form-control" required value="{{ edit_entry.duct_no if edit_entry else '' }}">
          </div>

          <div class="mb-2"><label>Type</label>
            <select class="form-control" name="duct_type" id="duct_type" onchange="toggleFields()" required>
              {% for type in ['ST','RED','DUM','OFFSET','SHOE','VANES','ELB'] %}
                <option value="{{ type }}" {% if edit_entry and edit_entry.duct_type == type %}selected{% endif %}>{{ type }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2"><label>Width1</label>
            <input type="number" name="width1" id="width1" step="0.01" class="form-control" required value="{{ edit_entry.width1 if edit_entry else '' }}" oninput="copyToSecond('width')">
          </div>

          <div class="mb-2"><label>Height1</label>
            <input type="number" name="height1" id="height1" step="0.01" class="form-control" required value="{{ edit_entry.height1 if edit_entry else '' }}" oninput="copyToSecond('height')">
          </div>

          <div class="mb-2"><label>Width2</label>
            <input type="number" name="width2" id="width2" step="0.01" class="form-control" value="{{ edit_entry.width2 if edit_entry else '' }}">
          </div>

          <div class="mb-2"><label>Height2</label>
            <input type="number" name="height2" id="height2" step="0.01" class="form-control" value="{{ edit_entry.height2 if edit_entry else '' }}">
          </div>

          <div class="mb-2"><label>Length/Radius</label>
            <input type="number" name="length_or_radius" step="0.01" class="form-control" required value="{{ edit_entry.length_or_radius if edit_entry else '' }}">
          </div>

          <div class="mb-2"><label>Quantity</label>
            <input type="number" name="quantity" class="form-control" required value="{{ edit_entry.quantity if edit_entry else '' }}">
          </div>

          <div class="mb-2" id="degreeDiv" style="display:none;"><label>Degree/Offset</label>
            <input type="number" name="degree_or_offset" step="0.01" class="form-control" value="{{ edit_entry.degree_or_offset if edit_entry else '' }}">
          </div>

          <div class="mb-2" id="factorDiv" style="display:none;"><label>Factor</label>
            <input type="number" name="factor" step="0.1" class="form-control" value="{{ edit_entry.factor if edit_entry else 1.0 }}">
          </div>

          <button type="submit" class="btn btn-primary mt-2">{{ 'Update' if edit_entry else 'Add' }}</button>
        </form>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-info mt-2">{{ messages[0] }}</div>
          {% endif %}
        {% endwith %}
      </div>

      <!-- Duct Entry Table -->
      <div class="table-section">
        <div class="d-flex justify-content-end mb-2 gap-2">
          <a href="{{ url_for('export_excel', project_id=project.id) }}" class="btn btn-success btn-sm">Excel</a>
          <a href="{{ url_for('export_pdf', project_id=project.id) }}" class="btn btn-danger btn-sm">PDF</a>
          <button onclick="window.print()" class="btn btn-outline-primary btn-sm">Print</button>
          <form method="POST" action="{{ url_for('submit_all', project_id=project.id) }}" class="d-inline">
            <button type="submit" class="btn btn-warning btn-sm">Submit All</button>
          </form>
        </div>

        <table class="table table-bordered table-sm">
          <thead class="table-light sticky-top">
            <tr>
              <th>#</th><th>Duct</th><th>Type</th><th>W1</th><th>H1</th><th>W2</th><th>H2</th>
              <th>Len</th><th>Qty</th><th>Deg/Off</th><th>Gauge</th>
              <th>24g</th><th>22g</th><th>20g</th><th>18g</th>
              <th>Nuts</th><th>Cleat</th><th>Gasket</th><th>Corner</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in entries %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ entry.duct_no }}</td>
              <td>{{ entry.duct_type }}</td>
              <td>{{ entry.width1 }}</td>
              <td>{{ entry.height1 }}</td>
              <td>{{ entry.width2 }}</td>
              <td>{{ entry.height2 }}</td>
              <td>{{ entry.length_or_radius }}</td>
              <td>{{ entry.quantity }}</td>
              <td>{{ entry.degree_or_offset }}</td>
              <td>{{ entry.gauge }}</td>
              <td>{{ '%.2f'|format(entry.area_24g) }}</td>
              <td>{{ '%.2f'|format(entry.area_22g) }}</td>
              <td>{{ '%.2f'|format(entry.area_20g) }}</td>
              <td>{{ '%.2f'|format(entry.area_18g) }}</td>
              <td>{{ entry.nuts }}</td>
              <td>{{ entry.cleat }}</td>
              <td>{{ '%.2f'|format(entry.gasket) }}</td>
              <td>{{ entry.corner }}</td>
              <td>
                <a href="{{ url_for('duct_entry', project_id=project.id) }}?edit={{ entry.id }}" class="btn btn-warning btn-sm">Edit</a>
                <a href="{{ url_for('delete_duct', id=entry.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Delete this entry?')">Delete</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function toggleFields() {
      const type = document.getElementById("duct_type").value;
      document.getElementById("factorDiv").style.display = ["RED", "OFFSET", "SHOE", "ELB"].includes(type) ? "block" : "none";
      document.getElementById("degreeDiv").style.display = ["OFFSET", "ELB"].includes(type) ? "block" : "none";
    }

    function copyToSecond(dim) {
      if (dim === 'width') {
        document.getElementById("width2").value = document.getElementById("width1").value;
      }
      if (dim === 'height') {
        document.getElementById("height2").value = document.getElementById("height1").value;
      }
    }

    window.onload = toggleFields;
  </script>
</body>
</html>
