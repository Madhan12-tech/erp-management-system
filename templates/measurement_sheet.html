<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Measurement Sheet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .container {
      margin: 20px auto;
      max-width: 1200px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
    }

    .top-info {
      display: flex;
      justify-content: space-between;
      background: #007bff;
      color: white;
      padding: 15px;
      border-radius: 6px;
    }

    .top-info div {
      flex: 1;
      padding: 0 15px;
    }

    h3 {
      margin-top: 30px;
    }

    .row {
      display: flex;
      gap: 20px;
    }

    .form-left, .table-right {
      flex: 1;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    th {
      background: #007bff;
      color: white;
    }

    button {
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
    }

    button:hover {
      background: #218838;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 10px;
      border-radius: 6px;
      display: none;
    }

    .actions button {
      background: #ffc107;
      margin-right: 5px;
    }

    .actions button:last-child {
      background: #dc3545;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="top-info">
    <div><strong>Enquiry ID:</strong> {{ project.enquiry_id }}</div>
    <div><strong>Client:</strong> {{ project.client }}</div>
    <div><strong>Location:</strong> {{ project.location }}</div>
  </div>

  <h3>Add Duct Measurement</h3>
  <div class="row">
    <div class="form-left">
      <form method="POST" action="/save_measurement/{{ project.id }}">
        <input type="text" name="duct_number" placeholder="Duct Number" required>
        <input type="text" name="duct_type" placeholder="Type" required>
        <input type="text" name="size" placeholder="Size (LxWxH)">
        <input type="number" name="quantity" placeholder="Quantity">
        <button type="submit">Add Entry</button>
      </form>
    </div>
    <div class="table-right">
      <table>
        <thead>
          <tr>
            <th>Duct No</th>
            <th>Type</th>
            <th>Size</th>
            <th>Qty</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in measurements %}
          <tr>
            <td>{{ row.duct_number }}</td>
            <td>{{ row.duct_type }}</td>
            <td>{{ row.size }}</td>
            <td>{{ row.quantity }}</td>
            <td class="actions">
              <form action="/edit_measurement/{{ row.id }}" method="POST" style="display:inline;">
                <button type="submit">Edit</button>
              </form>
              <form action="/delete_measurement/{{ row.id }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">
                <button type="submit">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <br>
  <button onclick="exportTableToCSV()">Export CSV</button>
  <button onclick="window.print()">Print</button>
  <button onclick="finalSubmit()">Final Submit</button>
</div>

<div class="toast" id="toast"></div>
<script>
  // Export table to CSV
  function exportTableToCSV() {
    const rows = document.querySelectorAll("table tbody tr");
    let csv = "Duct No,Type,Size,Qty\n";
    rows.forEach(row => {
      const cols = row.querySelectorAll("td:not(.actions)");
      const line = Array.from(cols).map(td => `"${td.innerText}"`).join(",");
      csv += line + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.setAttribute("href", url);
    a.setAttribute("download", "measurement_sheet.csv");
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Final submit logic (placeholder)
  function finalSubmit() {
    alert("Final submission completed!");
    // You can replace this with a POST call to update project status
  }

  // Show toast if flash messages exist
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      const toast = document.getElementById("toast");
      {% for category, message in messages %}
        toast.textContent = "{{ message }}";
        toast.style.backgroundColor = {
          success: '#28a745',
          danger: '#dc3545',
          warning: '#ffc107',
          info: '#17a2b8'
        }['{{ category }}'] || '#333';
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
      {% endfor %}
    {% endif %}
  {% endwith %}
</script>

</body>
</html>
