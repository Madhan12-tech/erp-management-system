<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vendors | Ducting ERP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            background: #f4f6f9;
        }

        .sidebar {
            height: 100vh;
            position: fixed;
            width: 240px;
            background-color: #343a40;
            color: white;
            padding-top: 20px;
        }

        .sidebar a {
            color: white;
            padding: 12px 20px;
            display: block;
            text-decoration: none;
        }

        .sidebar a:hover {
            background-color: #495057;
        }

        .main-content {
            margin-left: 240px;
            padding: 20px;
        }

        .topbar {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 30px;
        }

        .popup-form {
            position: fixed;
            top: 0;
            right: -100%;
            width: 420px;
            height: 100%;
            background: #ffffffdd;
            backdrop-filter: blur(8px);
            box-shadow: -5px 0 10px rgba(0,0,0,0.1);
            transition: right 0.4s ease;
            padding: 25px;
            overflow-y: auto;
            z-index: 100;
        }

        .popup-form.active {
            right: 0;
        }

        .popup-form h4 {
            margin-bottom: 20px;
            font-weight: 600;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 98;
        }

        .overlay.active {
            display: block;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h4 class="text-center">Ducting ERP</h4>
    <hr style="border-color: #555;">
    <a href="{{ url_for('dashboard') }}">Dashboard</a>
    <a href="{{ url_for('vendors') }}" style="background:#495057;">Vendors</a>
    <a href="#">Inventory</a>
    <a href="#">Accounts Purchase</a>
    <a href="#">Production</a>
    <a href="#">Project Sites</a>
    <a href="#">Transport</a>
    <a href="#">Workforce</a>
    <a href="#">Quotations & Invoices</a>
    <a href="{{ url_for('logout') }}">Logout</a>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="topbar">
        <h4>Vendor Management</h4>
        <span class="text-muted small">Manage all your suppliers here</span>
    </div>

    <!-- Table and filter will come in next parts -->
  <!-- Export Buttons + Filters -->
    <div class="card p-3 shadow-sm">
        <div class="mb-3">
            <a href="{{ url_for('export_vendors_csv') }}" class="btn btn-sm btn-outline-secondary">Export CSV</a>
            <a href="{{ url_for('export_vendors_excel') }}" class="btn btn-sm btn-outline-success">Export Excel</a>
            <a href="{{ url_for('export_vendors_pdf') }}" class="btn btn-sm btn-outline-danger">Export PDF</a>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Search by name, category or phone...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter" onchange="filterTable()">
                    <option value="">Filter by Category</option>
                    {% for vendor in vendors %}
                        {% if vendor[3] %}
                            <option>{{ vendor[3] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter" onchange="filterTable()">
                    <option value="">Filter by Status</option>
                    <option>Active</option>
                    <option>Inactive</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm" id="vendorTable">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Rating</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vendors %}
                    <tr>
                        <td>{{ v[1] }}</td>
                        <td>{{ v[2] }}</td>
                        <td>{{ v[3] }}</td>
                        <td>{{ v[4] }}</td>
                        <td>{{ v[5] }}</td>
                        <td>{{ v[6] }}</td>
                        <td>{{ v[7] }}</td>
                        <td>{{ v[9] }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-view" data-id="{{ v[0] }}">View</button>
                            <button class="btn btn-sm btn-warning btn-edit" data-id="{{ v[0] }}">Edit</button>
                            <form method="POST" action="{{ url_for('delete_vendor', id=v[0]) }}" style="display:inline;">
                                <button class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    </div> <!-- Closing .main-content -->

<!-- Floating Add Vendor Button -->
<button class="btn btn-primary add-btn" onclick="openForm()">+ Add Vendor</button>

<!-- Add Vendor Popup -->
<div class="popup-form" id="popupForm">
    <h4>Add New Vendor</h4>
    <form action="{{ url_for('add_vendor') }}" method="POST">
        <div class="mb-3">
            <label>Vendor ID</label>
            <input type="text" class="form-control" value="Auto-generated" disabled>
        </div>
        <div class="mb-3">
            <label>Name</label>
            <input type="text" name="name" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Category</label>
            <input type="text" name="category" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Email</label>
            <input type="email" name="email" class="form-control">
        </div>
        <div class="mb-3">
            <label>Phone</label>
            <input type="text" name="phone" class="form-control">
        </div>
        <div class="mb-3">
            <label>Address</label>
            <textarea name="address" class="form-control" rows="2"></textarea>
        </div>
        <div class="mb-3">
            <label>Status</label>
            <select name="status" class="form-control">
                <option>Active</option>
                <option>Inactive</option>
            </select>
        </div>
        <div class="mb-3">
            <label>Rating (1â€“5)</label>
            <input type="number" name="rating" class="form-control" min="1" max="5">
        </div>
        <div class="d-grid">
            <button class="btn btn-success">Save Vendor</button>
        </div>
    </form>
</div>

<!-- Edit Vendor Popup -->
<div class="popup-form" id="editForm">
    <h4>Edit Vendor</h4>
    <form id="editVendorForm" method="POST">
        <div class="mb-3">
            <label>Name</label>
            <input type="text" name="name" id="edit_name" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Category</label>
            <input type="text" name="category" id="edit_category" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Email</label>
            <input type="email" name="email" id="edit_email" class="form-control">
        </div>
        <div class="mb-3">
            <label>Phone</label>
            <input type="text" name="phone" id="edit_phone" class="form-control">
        </div>
        <div class="mb-3">
            <label>Address</label>
            <textarea name="address" id="edit_address" class="form-control"></textarea>
        </div>
        <div class="mb-3">
            <label>Status</label>
            <select name="status" id="edit_status" class="form-control">
                <option>Active</option>
                <option>Inactive</option>
            </select>
        </div>
        <div class="mb-3">
            <label>Rating</label>
            <input type="number" name="rating" id="edit_rating" class="form-control" min="1" max="5">
        </div>
        <div class="d-grid">
            <button class="btn btn-warning">Update Vendor</button>
        </div>
    </form>
</div>

<!-- View Vendor Popup -->
<div class="popup-form" id="viewForm">
    <h4>Vendor Details</h4>
    <div id="viewContent" class="text-muted small"></div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>
<!-- Scripts -->
<script>
    // ---------- Popup Logic ----------
    function openForm() {
        document.getElementById("popupForm").classList.add("active");
        document.getElementById("overlay").classList.add("active");
    }

    function closeAll() {
        document.getElementById("popupForm").classList.remove("active");
        document.getElementById("editForm").classList.remove("active");
        document.getElementById("viewForm").classList.remove("active");
        document.getElementById("overlay").classList.remove("active");
    }

    // ---------- View Vendor ----------
    document.querySelectorAll('.btn-view').forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            fetch(`/view_vendor/${id}`)
                .then(res => res.json())
                .then(data => {
                    let content = `
                        <p><strong>Vendor ID:</strong> ${data[1]}</p>
                        <p><strong>Name:</strong> ${data[2]}</p>
                        <p><strong>Category:</strong> ${data[3]}</p>
                        <p><strong>Email:</strong> ${data[4]}</p>
                        <p><strong>Phone:</strong> ${data[5]}</p>
                        <p><strong>Address:</strong> ${data[6]}</p>
                        <p><strong>Status:</strong> ${data[7]}</p>
                        <p><strong>Rating:</strong> ${data[8]}</p>
                        <p><strong>Last Updated:</strong> ${data[10]}</p>
                    `;
                    document.getElementById("viewContent").innerHTML = content;
                    document.getElementById("viewForm").classList.add("active");
                    document.getElementById("overlay").classList.add("active");
                });
        };
    });

    // ---------- Edit Vendor ----------
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id;
            fetch(`/view_vendor/${id}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("editVendorForm").action = `/edit_vendor/${id}`;
                    document.getElementById("edit_name").value = data[2];
                    document.getElementById("edit_category").value = data[3];
                    document.getElementById("edit_email").value = data[4];
                    document.getElementById("edit_phone").value = data[5];
                    document.getElementById("edit_address").value = data[6];
                    document.getElementById("edit_status").value = data[7];
                    document.getElementById("edit_rating").value = data[8];

                    document.getElementById("editForm").classList.add("active");
                    document.getElementById("overlay").classList.add("active");
                });
        };
    });

    // ---------- Search & Filter ----------
    const searchInput = document.getElementById("searchInput");
    const vendorTable = document.getElementById("vendorTable").getElementsByTagName("tbody")[0];

    searchInput.addEventListener("keyup", function () {
        const searchValue = this.value.toLowerCase();
        for (let row of vendorTable.rows) {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(searchValue) ? "" : "none";
        }
    });

    function filterTable() {
        const category = document.getElementById("categoryFilter").value.toLowerCase();
        const status = document.getElementById("statusFilter").value.toLowerCase();

        for (let row of vendorTable.rows) {
            const catCell = row.cells[2].innerText.toLowerCase();
            const statusCell = row.cells[5].innerText.toLowerCase();
            const show = (!category || catCell.includes(category)) && (!status || statusCell.includes(status));
            row.style.display = show ? "" : "none";
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
