<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
    }
    .sidebar {
      width: 200px;
      background: #2c3e50;
      height: 100vh;
      color: white;
      padding: 20px 0;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px 20px;
    }
    .sidebar a:hover {
      background: #34495e;
    }
    .main {
      flex: 1;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-form {
      position: fixed;
      right: -100%;
      top: 0;
      width: 400px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    .popup-form.open {
      right: 0;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
<div class="sidebar">
  <a href="/dashboard">Dashboard</a>
  <a href="/vendor_register">Vendors</a>
  <a href="/employee_register">Employees</a>
  <a href="/projects">Projects</a>
  <a href="/logout">Logout</a>
</div>
<div class="main">
  <div class="header">
    <h2>Project Management</h2>
    <button onclick="openPopup()">+ New Project</button>
  </div>
  <!-- Popup Form -->
<div id="projectPopup" class="popup-form">
  <h3>Add New Project</h3>
  <form action="/add_project" method="POST" enctype="multipart/form-data">
    <label>Enquiry ID (auto):</label>
    <input type="text" name="enquiry_id" id="enquiry_id" readonly placeholder="Auto-generated">

    <label>Client (Vendor):</label>
    <select name="client" id="clientDropdown" onchange="fillClientDetails()" required>
      <option value="">-- Select Vendor --</option>
      {% for v in vendors %}
        <option value="{{ v.name }}" data-gst="{{ v.gst_no }}" data-address="{{ v.address }}">{{ v.name }}</option>
      {% endfor %}
    </select>

    <label>Quotation RO:</label>
    <input type="text" name="quotation_ro" required>

    <label>Start Date:</label>
    <input type="date" name="start_date" value="{{ current_date }}" required>

    <label>End Date:</label>
    <input type="date" name="end_date" required>

    <label>Location:</label>
    <input type="text" name="location">

    <label>GST Number:</label>
    <input type="text" name="gst_no" id="gst_no" readonly>

    <label>Address:</label>
    <textarea name="address" id="address" readonly></textarea>

    <label>Project Incharge:</label>
    <select name="project_incharge" required>
      <option value="">-- Select Incharge --</option>
      {% for emp in employees %}
        <option value="{{ emp.name }}">{{ emp.name }}</option>
      {% endfor %}
    </select>

    <label>Notes:</label>
    <textarea name="notes"></textarea>

    <label>Upload Source Drawing:</label>
    <input type="file" name="source_drawing">

    <button type="submit">Save and Continue</button>
  </form>
</div>
<!-- Project List Table -->
<h3>Project List</h3>
<table>
  <thead>
    <tr>
      <th>Enquiry ID</th>
      <th>Client</th>
      <th>Start</th>
      <th>End</th>
      <th>Location</th>
      <th>Incharge</th>
      <th>Design Stage</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for p in projects %}
    <tr>
      <td>{{ p.enquiry_id }}</td>
      <td>{{ p.client }}</td>
      <td>{{ p.start_date }}</td>
      <td>{{ p.end_date }}</td>
      <td>{{ p.location }}</td>
      <td>{{ p.project_incharge }}</td>
      <td>{{ p.design_status }}</td>
      <td>
        {% if p.design_status == 'preparation' %}
          <a href="/add_measurement/{{ p.id }}"><button>Measurement</button></a>
          <a href="/mark_design_stage/{{ p.id }}/completed"><button>Mark Completed</button></a>
        {% elif p.design_status == 'completed' %}
          <a href="/mark_design_stage/{{ p.id }}/submitted"><button>Submit</button></a>
        {% elif p.design_status == 'submitted' %}
          <a href="/mark_design_stage/{{ p.id }}/under_review"><button>Under Review</button></a>
        {% elif p.design_status == 'under_review' %}
          <a href="/mark_design_stage/{{ p.id }}/approved"><button>Approve</button></a>
        {% elif p.design_status == 'approved' %}
          âœ… Sent to Production
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- Toast Notification -->
<div id="toast" class="toast"></div>

<script>
  function openPopup() {
    document.getElementById("projectPopup").classList.add("open");
    generateEnquiryID();
  }

  function closePopup() {
    document.getElementById("projectPopup").classList.remove("open");
  }

  function fillClientDetails() {
    const clientDropdown = document.getElementById("clientDropdown");
    const selected = clientDropdown.options[clientDropdown.selectedIndex];
    const gst = selected.getAttribute("data-gst");
    const address = selected.getAttribute("data-address");
    document.getElementById("gst_no").value = gst;
    document.getElementById("address").value = address;
  }

  function generateEnquiryID() {
    // Optionally handled by server. Leave blank or show placeholder
    document.getElementById("enquiry_id").placeholder = "Auto-generated by server";
  }

  // Toast logic
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      const toast = document.getElementById("toast");
      {% for category, message in messages %}
        toast.textContent = "{{ message }}";
        toast.style.backgroundColor = {
          success: '#28a745',
          danger: '#dc3545',
          warning: '#ffc107',
          info: '#17a2b8'
        }['{{ category }}'] || '#333';
        toast.style.display = "block";
        setTimeout(() => toast.style.display = "none", 3000);
      {% endfor %}
    {% endif %}
  {% endwith %}
</script>
</div> <!-- close .main -->
</body>
</html>
