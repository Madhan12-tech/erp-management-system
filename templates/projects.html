<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">üìÅ Project Management</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProjectModal">‚ûï Add New Project</button>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info">{{ messages[0] }}</div>
    {% endif %}
  {% endwith %}

  {% for project in projects %}
  <div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <strong>{{ project.project_name }}</strong>
      <span class="badge bg-secondary">Enquiry No: {{ project.enquiry_no }}</span>
    </div>
    <div class="card-body">
      <p><strong>Engineer:</strong> {{ project.site_engineer }} | <strong>Contact:</strong> {{ project.site_contact }}</p>
      <p><strong>Location:</strong> {{ project.location }}</p>

      <!-- üß≠ Design Process -->
      <h5 class="text-primary">üß≠ Design Process</h5>
      <div class="d-flex flex-wrap gap-2 mb-3">
        {% if project.status == 'new' %}
          <form method="POST" action="/submit_measurement/{{ project.id }}">
            <button class="btn btn-warning">üìã Save & Continue to Measurement Sheet</button>
          </form>
        {% elif project.status == 'preparation' %}
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#measurementSheetModal{{ project.id }}">
            üìê Measurement Sheet
          </button>
          <form method="POST" action="/submit_for_review/{{ project.id }}">
            <button class="btn btn-secondary">üöß Submit for Review</button>
          </form>
        {% elif project.status == 'under_review' %}
          <span class="badge bg-info text-dark p-2">‚è≥ Under Review</span>
        {% elif project.status == 'submitted for approval' %}
          <form method="POST" action="/approve_project/{{ project.id }}">
            <button class="btn btn-success">‚úÖ Approve Project</button>
          </form>
        {% elif project.status == 'approved' %}
          <span class="badge bg-success p-2">üéØ Approved</span>
        {% else %}
          <span class="badge bg-secondary p-2">‚öôÔ∏è {{ project.status }}</span>
        {% endif %}
      </div>

      <!-- üìä Right Side Live Table -->
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Duct No</th>
              <th>Type</th>
              <th>W1</th>
              <th>H1</th>
              <th>W2</th>
              <th>H2</th>
              <th>Len/Rad</th>
              <th>Qty</th>
              <th>Deg/Off</th>
              <th>Gauge</th>
              <th>Area</th>
              <th>Nuts</th>
              <th>Cleat</th>
              <th>Gasket</th>
              <th>Corner</th>
            </tr>
          </thead>
          <tbody>
            {% for duct in project.ducts %}
              <tr>
                <td>{{ duct.duct_no }}</td>
                <td>{{ duct.duct_type }}</td>
                <td>{{ duct.width1 }}</td>
                <td>{{ duct.height1 }}</td>
                <td>{{ duct.width2 }}</td>
                <td>{{ duct.height2 }}</td>
                <td>{{ duct.length_or_radius }}</td>
                <td>{{ duct.quantity }}</td>
                <td>{{ duct.degree_or_offset }}</td>
                <td>{{ duct.gauge }}</td>
                <td>{{ "%.2f"|format(duct.area) }}</td>
                <td>{{ duct.nuts_bolts }}</td>
                <td>{{ duct.cleat }}</td>
                <td>{{ "%.2f"|format(duct.gasket) }}</td>
                <td>{{ duct.corner_pieces }}</td>
              </tr>
            {% else %}
              <tr><td colspan="15" class="text-center text-muted">No duct entries available.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- üì§ Export Buttons -->
      <div class="mt-3 d-flex gap-2">
        <a href="/export_excel/{{ project.id }}" class="btn btn-outline-success">‚¨áÔ∏è Export Excel</a>
        <a href="/export_pdf/{{ project.id }}" class="btn btn-outline-danger">üßæ Export PDF</a>
        <form method="POST" action="/submit_all/{{ project.id }}">
          <button class="btn btn-dark">‚úÖ Submit All</button>
        </form>
      </div>
    </div>
  </div>

  <!-- üìã Measurement Sheet Modal -->
  <div class="modal fade" id="measurementSheetModal{{ project.id }}" tabindex="-1" aria-labelledby="measurementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <form method="POST" action="/add_duct" class="p-3">
          <div class="modal-header">
            <h5 class="modal-title">üìê Measurement Sheet Entry - {{ project.project_name }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body row g-3">
            <input type="hidden" name="project_id" value="{{ project.id }}">

            <div class="col-md-3"><label>Duct No</label><input name="duct_no" class="form-control" required></div>
            <div class="col-md-3"><label>Duct Type</label>
              <select name="duct_type" class="form-select" required>
                <option value="ST">ST</option>
                <option value="RED">RED</option>
                <option value="DUM">DUM</option>
                <option value="OFFSET">OFFSET</option>
                <option value="SHOE">SHOE</option>
                <option value="ELB">ELB</option>
                <option value="VANES">VANES</option>
              </select>
            </div>
            <div class="col-md-2"><label>Width 1</label><input name="width1" type="number" step="0.01" class="form-control" required></div>
            <div class="col-md-2"><label>Height 1</label><input name="height1" type="number" step="0.01" class="form-control" required></div>
            <div class="col-md-2"><label>Width 2</label><input name="width2" type="number" step="0.01" class="form-control"></div>
            <div class="col-md-2"><label>Height 2</label><input name="height2" type="number" step="0.01" class="form-control"></div>
            <div class="col-md-2"><label>Length/Radius</label><input name="length_or_radius" type="number" step="0.01" class="form-control" required></div>
            <div class="col-md-2"><label>Qty</label><input name="quantity" type="number" class="form-control" required></div>
            <div class="col-md-2"><label>Deg/Off</label><input name="degree_or_offset" type="number" step="0.01" class="form-control"></div>

          </div>
          <div class="modal-footer mt-3">
            <button type="submit" class="btn btn-primary">‚ûï Add Duct Entry</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% endfor %}

  <!-- ‚ûï Add Project Modal -->
  <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="POST" action="/save_project" class="p-3">
          <div class="modal-header">
            <h5 class="modal-title">‚ûï Add New Project</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body row g-3">
            <div class="col-md-6"><label>Project Name</label><input name="project_name" class="form-control" required></div>
            <div class="col-md-6"><label>Enquiry No</label><input name="enquiry_no" class="form-control" required></div>
            <div class="col-md-6"><label>Office No</label><input name="office_no" class="form-control"></div>
            <div class="col-md-6"><label>Site Engineer</label><input name="site_engineer" class="form-control"></div>
            <div class="col-md-6"><label>Contact</label><input name="site_contact" class="form-control"></div>
            <div class="col-md-6"><label>Location</label><input name="location" class="form-control"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save Project</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
</body>
</html>
