<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f5f7fa;
    }
    .top-bar {
      background-color: #2c3e50;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .top-bar input[type="text"] {
      padding: 6px;
      border-radius: 4px;
      border: none;
      width: 200px;
    }
    .top-bar button {
      background-color: #27ae60;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }

    /* Add Project Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      padding-top: 100px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .modal-content label {
      display: block;
      margin-top: 10px;
    }

    .modal-content input,
    .modal-content select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .modal-content .btn-group {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .modal-content .btn-group button {
      margin-left: 10px;
      padding: 8px 14px;
    }
  </style>
</head>
<body>

<div class="top-bar">
  <input type="text" id="searchInput" placeholder="Search Projects...">
  <button onclick="openAddProjectModal()">+ Add Project</button>
</div>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal">
  <div class="modal-content">
    <h3>Add Project</h3>
    <form method="POST" action="/add_project">
      <label for="project_name">Project Name:</label>
      <input type="text" name="project_name" required>

      <label for="vendor">Vendor:</label>
      <select name="vendor" required>
        <option value="">-- Select Vendor --</option>
        <option value="ABC Pvt Ltd">ABC Pvt Ltd</option>
        <option value="XYZ Industries">XYZ Industries</option>
      </select>

      <label for="location">Location:</label>
      <input type="text" name="location" required>

      <div class="btn-group">
        <button type="button" onclick="closeAddProjectModal()">Cancel</button>
        <button type="submit">Save Project</button>
      </div>
    </form>
  </div>
</div>

  <!-- Search Box -->
<div style="margin: 20px 0; text-align: center;">
  <input type="text" id="projectSearch" placeholder="Search project by vendor, location or status..." 
         style="padding: 10px; width: 60%; border-radius: 5px; border: 1px solid #ccc;">
</div>

<script>
  document.getElementById("projectSearch").addEventListener("input", function () {
    let filter = this.value.toLowerCase();
    let cards = document.getElementsByClassName("project-card");

    Array.from(cards).forEach(function (card) {
      let text = card.textContent.toLowerCase();
      card.style.display = text.includes(filter) ? "block" : "none";
    });
  });
</script>

<!-- Live Project Cards -->
<div id="projectCards" style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
  {% for project in projects %}
  <div class="project-card" style="background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 15px;">
    <h3>{{ project.project_name }}</h3>
    <p><strong>Vendor:</strong> {{ project.vendor }}</p>
    <p><strong>Location:</strong> {{ project.location }}</p>
    <p><strong>Status:</strong> {{ project.status }}</p>
    <a href="/design_process/{{ project.project_id }}" style="color: #2980b9;">Continue Design â†’</a>
  </div>
  {% endfor %}
</div>

<!-- Flash Message Toast -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="toast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; background-color: #2ecc71; color: white; padding: 10px 20px; border-radius: 6px; display: none;">
      {% for category, message in messages %}
        {{ message }}
      {% endfor %}
    </div>
    <script>
      document.getElementById('toast').style.display = 'block';
      setTimeout(() => { document.getElementById('toast').style.display = 'none'; }, 3000);
    </script>
  {% endif %}
{% endwith %}

<script>
  // Modal open/close
  function openAddProjectModal() {
    document.getElementById("addProjectModal").style.display = "block";
  }

  function closeAddProjectModal() {
    document.getElementById("addProjectModal").style.display = "none";
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById("addProjectModal");
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  // Search filter
  document.getElementById("searchInput").addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    const cards = document.querySelectorAll(".project-card");

    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(filter) ? "" : "none";
    });
  });
</script>

<!-- Measurement Sheet Popup -->
<div id="measurementModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000;">
  <div class="modal-content" style="background:white; margin:5% auto; padding:20px; width:90%; max-width:900px; border-radius:10px; position:relative;">
    <span onclick="closeMeasurementModal()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>

    <h2 style="margin-bottom:20px;">Measurement Sheet Entry</h2>

    <!-- Project Info -->
    <div style="margin-bottom: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
      <input type="text" id="clientName" placeholder="Client Name" class="form-control" required>
      <input type="text" id="projectLocation" placeholder="Location" class="form-control" required>
      <input type="text" id="engineerName" placeholder="Site Engineer Name" class="form-control" required>
    </div>

    <!-- Duct Entry Form -->
    <div style="margin-bottom: 15px;">
      <h4>Duct Entry</h4>
      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
        <input type="text" id="ductType" placeholder="Type" class="form-control">
        <input type="number" id="length" placeholder="Length" class="form-control">
        <input type="number" id="width" placeholder="Width" class="form-control">
        <input type="number" id="height" placeholder="Height" class="form-control">
        <input type="number" id="quantity" placeholder="Qty" class="form-control">
      </div>
      <button type="button" onclick="addDuctRow()" style="margin-top:10px; padding:5px 10px;">+ Add Duct</button>
    </div>

    <!-- Duct Live Table -->
    <table id="ductTable" border="1" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
      <thead style="background:#f4f4f4;">
        <tr>
          <th>Type</th>
          <th>L</th>
          <th>W</th>
          <th>H</th>
          <th>Qty</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="ductTableBody">
        <!-- Rows will be added dynamically -->
      </tbody>
    </table>

    <!-- Submit/Export Buttons -->
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button onclick="exportDuctTable()">Export</button>
      <button onclick="printDuctTable()">Print</button>
      <button onclick="submitMeasurementSheet()" style="background:green; color:white;">Submit</button>
    </div>
  </div>
</div>

<script>
  function openMeasurementModal() {
    document.getElementById('measurementModal').style.display = 'block';
  }

  function closeMeasurementModal() {
    document.getElementById('measurementModal').style.display = 'none';
  }

  function addDuctRow() {
    const type = document.getElementById("ductType").value;
    const l = document.getElementById("length").value;
    const w = document.getElementById("width").value;
    const h = document.getElementById("height").value;
    const qty = document.getElementById("quantity").value;

    if (type && l && w && h && qty) {
      const table = document.getElementById("ductTableBody");
      const row = table.insertRow();

      row.innerHTML = `
        <td>${type}</td>
        <td>${l}</td>
        <td>${w}</td>
        <td>${h}</td>
        <td>${qty}</td>
        <td><button onclick="this.parentElement.parentElement.remove()">Delete</button></td>
      `;

      // Clear input
      document.getElementById("ductType").value = "";
      document.getElementById("length").value = "";
      document.getElementById("width").value = "";
      document.getElementById("height").value = "";
      document.getElementById("quantity").value = "";
    }
  }

  function exportDuctTable() {
    alert("Export logic here (CSV or Excel)");
  }

  function printDuctTable() {
    window.print();
  }

  function submitMeasurementSheet() {
    alert("Submitted successfully!");
    closeMeasurementModal();
  }
</script>
<!-- Design Process Steps (below each project card) -->
<div style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 10px;">
  <h3 style="margin-bottom: 10px;">Design Process</h3>
  <div style="display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
    
    <button onclick="startPreparation()" style="flex: 1; padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px;">Preparation</button>

    <button onclick="tagDrawing()" style="flex: 1; padding: 10px; background: #f39c12; color: white; border: none; border-radius: 5px;">Tag Drawing</button>

    <button onclick="markComplete()" style="flex: 1; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px;">Completed</button>

    <button onclick="submitApproval()" style="flex: 1; padding: 10px; background: #9b59b6; color: white; border: none; border-radius: 5px;">Submit for Approval</button>
  </div>

  <!-- Status Control -->
  <div style="margin-top: 15px;">
    <span>Status:</span>
    <button onclick="markUnderReview()" style="margin-left:10px; background: #e67e22; color: white; border: none; padding: 5px 10px;">Under Review</button>
    <button onclick="markApproved()" style="margin-left:5px; background: #2ecc71; color: white; border: none; padding: 5px 10px;">Approved</button>
  </div>
</div>

<script>
  function startPreparation() {
    alert("Preparation started. Redirect to Preparation page.");
    // Optionally: window.location.href = "/design_preparation";
  }

  function tagDrawing() {
    alert("Tag drawing phase selected.");
  }

  function markComplete() {
    alert("Marked as completed.");
  }

  function submitApproval() {
    alert("Submitted for approval.");
  }

  function markUnderReview() {
    alert("Marked as Under Review.");
  }

  function markApproved() {
    alert("Approved! Will move to Production Module.");
  }
</script>
<!-- Toast Notifications -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      {% for category, message in messages %}
        <div style="background: {% if category == 'success' %}#2ecc71{% elif category == 'error' %}#e74c3c{% else %}#3498db{% endif %};
                    color: white; padding: 10px 20px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    <script>
      setTimeout(() => {
        const toast = document.getElementById('toast-container');
        if (toast) toast.remove();
      }, 4000);
    </script>
  {% endif %}
{% endwith %}

<!-- Add Project Popup -->
<div id="addProjectPopup" class="popup-overlay" style="display: none;">
  <div class="popup-content" style="background: white; padding: 20px; border-radius: 10px; width: 500px; margin: auto;">
    <h2>Add New Project</h2>
    <form action="/add_project" method="POST">
      <label for="enquiry_id">Enquiry ID:</label>
      <input type="text" name="enquiry_id" required>

      <label for="vendor_id">Vendor:</label>
      <select name="vendor_id" id="vendorSelect" required onchange="autoFillVendorDetails()">
        <option value="">-- Select Vendor --</option>
        {% for vendor in vendors %}
          <option value="{{ vendor.id }}" data-gst="{{ vendor.gst_number }}" data-address="{{ vendor.address }}">{{ vendor.name }}</option>
        {% endfor %}
      </select>

      <label for="vendor_gst">Vendor GST:</label>
      <input type="text" id="vendor_gst" name="vendor_gst" readonly>

      <label for="vendor_address">Vendor Address:</label>
      <input type="text" id="vendor_address" name="vendor_address" readonly>

      <label for="location">Location:</label>
      <input type="text" name="location" required>

      <label for="status">Status:</label>
      <select name="status" required>
        <option value="Preparation">Preparation</option>
        <option value="Tag Drawing">Tag Drawing</option>
        <option value="Completed">Completed</option>
        <option value="Submit">Submit</option>
      </select>

      <div style="margin-top: 15px; display: flex; justify-content: space-between;">
        <button type="submit" style="padding: 8px 20px;">Add</button>
        <button type="button" onclick="closeAddProjectPopup()" style="padding: 8px 20px; background: #e74c3c; color: white;">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Project Button -->
<div style="text-align: right; margin-top: 10px;">
  <button onclick="openAddProjectPopup()" style="padding: 10px 20px; background: #2980b9; color: white; border: none; border-radius: 5px;">+ Add Project</button>
</div>

<script>
  function openAddProjectPopup() {
    document.getElementById("addProjectPopup").style.display = "block";
  }

  function closeAddProjectPopup() {
    document.getElementById("addProjectPopup").style.display = "none";
  }

  function autoFillVendorDetails() {
    const select = document.getElementById("vendorSelect");
    const selected = select.options[select.selectedIndex];
    document.getElementById("vendor_gst").value = selected.getAttribute("data-gst") || "";
    document.getElementById("vendor_address").value = selected.getAttribute("data-address") || "";
  }
</script>
<!-- Measurement Sheet Popup -->
<div id="measurementSheetPopup" class="popup-overlay" style="display: none;">
  <div class="popup-content" style="background: white; padding: 20px; width: 90%; max-width: 1000px; margin: auto; border-radius: 10px;">
    <h2>Measurement Sheet Entry</h2>
    <form id="measurementForm" action="/submit_measurement_sheet" method="POST">
      <div style="display: flex; gap: 20px;">
        <!-- Left: Client Details -->
        <div style="flex: 1;">
          <label>Client Name:</label>
          <input type="text" name="client_name" required>
          <label>Company Name:</label>
          <input type="text" name="company_name" required>
          <label>Site Engineer:</label>
          <input type="text" name="site_engineer" required>
          <label>Mobile:</label>
          <input type="text" name="mobile" required>
          <label>Location:</label>
          <input type="text" name="location" required>
        </div>

        <!-- Right: Duct Entry -->
        <div style="flex: 2;">
          <label>Duct Type:</label>
          <input type="text" id="duct_type">
          <label>Length (m):</label>
          <input type="number" id="length">
          <label>Breadth (m):</label>
          <input type="number" id="breadth">
          <label>Quantity:</label>
          <input type="number" id="quantity">
          <button type="button" onclick="addDuctEntry()" style="margin-top: 10px;">Add Entry</button>

          <!-- Live Table -->
          <table id="ductTable" border="1" style="width: 100%; margin-top: 10px;">
            <thead>
              <tr>
                <th>Type</th>
                <th>Length</th>
                <th>Breadth</th>
                <th>Qty</th>
                <th>Area (sqm)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="ductTableBody"></tbody>
          </table>
          <input type="hidden" name="duct_data" id="ductDataField">
        </div>
      </div>

      <div style="margin-top: 20px; text-align: right;">
        <button type="submit">Submit</button>
        <button type="button" onclick="exportToExcel()">Export</button>
        <button type="button" onclick="printTable()">Print</button>
        <button type="button" onclick="closeMeasurementSheetPopup()" style="background: red; color: white;">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  let ductEntries = [];

  function openMeasurementSheetPopup() {
    document.getElementById("measurementSheetPopup").style.display = "block";
  }

  function closeMeasurementSheetPopup() {
    document.getElementById("measurementSheetPopup").style.display = "none";
  }

  function addDuctEntry() {
    const type = document.getElementById("duct_type").value;
    const length = parseFloat(document.getElementById("length").value);
    const breadth = parseFloat(document.getElementById("breadth").value);
    const qty = parseInt(document.getElementById("quantity").value);

    if (!type || isNaN(length) || isNaN(breadth) || isNaN(qty)) return;

    const area = ((length * breadth) * qty).toFixed(2);
    const entry = { type, length, breadth, qty, area };
    ductEntries.push(entry);
    updateDuctTable();
  }

  function updateDuctTable() {
    const body = document.getElementById("ductTableBody");
    body.innerHTML = "";

    ductEntries.forEach((entry, index) => {
      const row = `<tr>
        <td>${entry.type}</td>
        <td>${entry.length}</td>
        <td>${entry.breadth}</td>
        <td>${entry.qty}</td>
        <td>${entry.area}</td>
        <td><button type="button" onclick="deleteDuctEntry(${index})">Delete</button></td>
      </tr>`;
      body.innerHTML += row;
    });

    document.getElementById("ductDataField").value = JSON.stringify(ductEntries);
  }

  function deleteDuctEntry(index) {
    ductEntries.splice(index, 1);
    updateDuctTable();
  }

  function exportToExcel() {
    let table = document.getElementById("ductTable").outerHTML;
    const blob = new Blob(["\ufeff", table], { type: "application/vnd.ms-excel" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "MeasurementSheet.xls";
    a.click();
  }

  function printTable() {
    const printContents = document.getElementById("ductTable").outerHTML;
    const win = window.open('', '', 'height=600,width=800');
    win.document.write('<html><head><title>Print</title></head><body>');
    win.document.write(printContents);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
  }
</script>
<!-- Popup Handling -->
<script>
  function openAddProjectPopup() {
    document.getElementById("addProjectPopup").style.display = "block";
  }

  function closeAddProjectPopup() {
    document.getElementById("addProjectPopup").style.display = "none";
  }

  function openMeasurementPopup(projectId) {
    document.getElementById("measurementSheetPopup").style.display = "block";
    document.getElementById("project_id").value = projectId;
  }

  function closeMeasurementPopup() {
    document.getElementById("measurementSheetPopup").style.display = "none";
  }

  // Auto-fill GST and address on vendor select
  document.getElementById("vendor").addEventListener("change", function () {
    const selectedOption = this.options[this.selectedIndex];
    const gst = selectedOption.getAttribute("data-gst");
    const address = selectedOption.getAttribute("data-address");

    document.getElementById("gst").value = gst || "";
    document.getElementById("address").value = address || "";
  });
</script>

<!-- Search Filter -->
<script>
  function filterProjects() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const cards = document.querySelectorAll(".project-card");

    cards.forEach(card => {
      const content = card.innerText.toLowerCase();
      if (content.includes(input)) {
        card.style.display = "block";
      } else {
        card.style.display = "none";
      }
    });
  }
</script>

<!-- Toast Notification -->
<script>
  function showToast(message, color = "green") {
    const toast = document.createElement("div");
    toast.innerText = message;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.background = color;
    toast.style.color = "white";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "5px";
    toast.style.zIndex = "9999";
    toast.style.boxShadow = "0 0 10px rgba(0,0,0,0.2)";
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // Check for flash messages from Flask
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for msg in messages %}
        showToast("{{ msg }}");
      {% endfor %}
    {% endif %}
  {% endwith %}
</script>
<!-- Optional Footer -->
<footer style="text-align: center; margin-top: 50px; font-size: 14px; color: #888;">
  <p>&copy; 2025 Ducting ERP System. All rights reserved.</p>
</footer>

</div> <!-- End of .container -->

<!-- Optional Custom Scrollbar Styling -->
<style>
  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>

</body>
</html>
