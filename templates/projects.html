<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Management | Ducting ERP</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #ecf0f1;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #2c3e50;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .add-project-btn {
      padding: 10px 16px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .add-project-btn:hover {
      background-color: #219150;
    }

    .project-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .project-card {
      background: #fff;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    .project-card:hover {
      transform: translateY(-4px);
    }
  </style>
</head>
<body>

  <h2>Project Management</h2>
  <button class="add-project-btn" onclick="openAddProject()">+ Add Project</button>

  <div class="project-container">
{% for project in projects %}
      <div class="project-card" data-id="{{ project['id'] }}">
        <h3 style="margin-top:0;">Enquiry ID: {{ project['enquiry_id'] }}</h3>
        <p><strong>Vendor:</strong> {{ project['vendor_name'] }}</p>
        <p><strong>Location:</strong> {{ project['location'] }}</p>
        <p>
          <strong>Status:</strong>
          {% if project['status'] == 'preparation' %}
            <span class="status-badge badge-preparation">Preparation</span>
          {% elif project['status'] == 'submitted' %}
            <span class="status-badge badge-submitted">Submitted</span>
          {% elif project['status'] == 'under_review' %}
            <span class="status-badge badge-review">Under Review</span>
          {% elif project['status'] == 'approved' %}
            <span class="status-badge badge-approved">Approved</span>
          {% endif %}
        </p>

        <div class="design-process">
          <h4 style="margin-bottom: 8px;">Design Process</h4>
          <div class="actions">
            {% if project['status'] == 'preparation' %}
              <button style="background-color:#2980b9; color:white;" onclick="openPreparationPopup({{ project['id'] }})">Preparation</button>
            {% elif project['status'] == 'submitted' %}
              <button style="background-color:#e67e22; color:white;" disabled>Submitted</button><br><br>
              <button style="background-color:#c0392b; color:white;" onclick="setStatus({{ project['id'] }}, 'under_review')">Under Review</button>
              <button style="background-color:#2ecc71; color:white;" onclick="approveProject({{ project['id'] }})">Approve</button>
            {% elif project['status'] == 'under_review' %}
              <button style="background-color:#f1c40f; color:white;" onclick="openPreparationPopup({{ project['id'] }})">Back to Design</button>
            {% elif project['status'] == 'approved' %}
              <button style="background-color:#27ae60; color:white;" disabled>Approved</button>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div> <!-- project-container -->

  <!-- ===== POPUP 1: Site Info Form ===== -->
<div id="prepPopup" style="
  display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:#fff; padding:25px; border-radius:10px;
  box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:9999; width:400px;">

  <h3 style="margin-top:0; color:#2c3e50;">Enter Site Details</h3>
  <form id="prepForm">
    <input type="hidden" name="project_id" id="prep_project_id">

    <label>Client Name:</label>
    <input type="text" name="client_name" required style="width:100%; padding:8px;"><br><br>

    <label>Project Location:</label>
    <input type="text" name="site_location" required style="width:100%; padding:8px;"><br><br>

    <label>Site Engineer Name:</label>
    <input type="text" name="engineer_name" required style="width:100%; padding:8px;"><br><br>

    <label>Mobile Number:</label>
    <input type="text" name="mobile" required style="width:100%; padding:8px;"><br><br>

    <div style="display:flex; justify-content: space-between;">
      <button type="button" onclick="savePrepForm()" style="background:#2ecc71; color:white; padding:8px 16px; border:none; border-radius:6px;">Save</button>
      <button type="button" onclick="closePrepPopup()" style="background:#e74c3c; color:white; padding:8px 16px; border:none; border-radius:6px;">Cancel</button>
    </div>
  </form>
</div>

  <!-- ===== POPUP 2: Duct Entry + Live Table ===== -->
<div id="ductPopup" style="
  display:none; position:fixed; top:5%; left:5%; width:90%; height:90%;
  background:#fff; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.3);
  z-index:9999; overflow-y:auto; padding:20px;">

  <h3 style="margin-bottom:20px;">Design Entry: <span id="duct_project_title"></span></h3>
  <div style="display:flex; gap:30px; flex-wrap:wrap;">
    
    <!-- Left: Form -->
    <div style="flex:1; min-width:280px;">
      <form id="ductForm">
        <input type="hidden" name="project_id" id="duct_project_id">

        <label>Duct Type:</label>
        <input type="text" name="type" required style="width:100%; padding:6px;"><br><br>

        <label>Length:</label>
        <input type="number" name="length" required style="width:100%; padding:6px;"><br><br>

        <label>Width:</label>
        <input type="number" name="width" required style="width:100%; padding:6px;"><br><br>

        <label>Height:</label>
        <input type="number" name="height" required style="width:100%; padding:6px;"><br><br>

        <label>Quantity:</label>
        <input type="number" name="quantity" required style="width:100%; padding:6px;"><br><br>

        <button type="button" onclick="addDuctRow()" style="background:#3498db; color:white; padding:8px 12px; border:none; border-radius:6px;">+ Add Entry</button>
      </form>
    </div>

    <!-- Right: Live Table -->
    <div style="flex:2; min-width:480px;">
      <h4>Live Duct Table</h4>
      <table id="ductTable" border="1" width="100%" cellpadding="6" style="border-collapse:collapse; background:#fdfdfd;">
        <thead style="background:#ecf0f1;">
          <tr>
            <th>Type</th><th>Length</th><th>Width</th><th>Height</th><th>Qty</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="ductTableBody"></tbody>
      </table>

      <div style="margin-top:20px;">
        <button onclick="exportToExcel()" style="padding:6px 12px;">üì§ Export Excel</button>
        <button onclick="printTable()" style="padding:6px 12px;">üñ®Ô∏è Print</button>
        <button onclick="submitSheet()" style="padding:6px 12px; background:#2ecc71; color:white;">‚úîÔ∏è Submit</button>
        <button onclick="closeDuctPopup()" style="padding:6px 12px; background:#e74c3c; color:white;">‚úñÔ∏è Close</button>
      </div>
    </div>
  </div>
</div>

  <script>
  
  }

  function openPreparationPopup(projectId) {
    document.getElementById("prepPopup").style.display = "block";
    document.getElementById("prep_project_id").value = projectId;
  }

  function closePrepPopup() {
    document.getElementById("prepPopup").style.display = "none";
  }

  function savePrepForm() {
    const form = document.getElementById("prepForm");
    const formData = new FormData(form);

    fetch("/add_measurement", {
      method: "POST",
      body: formData
    }).then(res => {
      if (res.ok) {
        closePrepPopup();
        openDuctPopup(formData.get("project_id"));
      } else {
        alert("‚ùå Failed to save site details.");
      }
    });
  }

  function openDuctPopup(projectId) {
    document.getElementById("ductPopup").style.display = "block";
    document.getElementById("duct_project_id").value = projectId;
    document.getElementById("duct_project_title").innerText = "Project #" + projectId;
    loadDuctTable(projectId);
  }

  function closeDuctPopup() {
    document.getElementById("ductPopup").style.display = "none";
  }

  function addDuctRow() {
    const form = document.getElementById("ductForm");
    const formData = new FormData(form);

    fetch("/add_duct", {
      method: "POST",
      body: formData
    }).then(res => {
      if (res.ok) {
        loadDuctTable(formData.get("project_id"));
        form.reset();
      } else {
        alert("‚ùå Error adding duct entry.");
      }
    });
  }

  function loadDuctTable(projectId) {
    fetch(`/api/ducts/${projectId}`)
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById("ductTableBody");
        tbody.innerHTML = "";
        data.forEach(row => {
          tbody.innerHTML += `
            <tr>
              <td>${row.type}</td>
              <td>${row.length}</td>
              <td>${row.width}</td>
              <td>${row.height}</td>
              <td>${row.quantity}</td>
              <td><button onclick="deleteDuct(${row.id}, ${projectId})">üóëÔ∏è</button></td>
            </tr>`;
        });
      });
  }

  function deleteDuct(id, projectId) {
    fetch(`/delete_duct/${id}`, {
      method: "POST"
    }).then(res => {
      if (res.ok) loadDuctTable(projectId);
    });
  }

  function exportToExcel() {
    alert("üì§ Export to Excel clicked (backend pending)");
  }

  function printTable() {
    window.print();
  }

  function submitSheet() {
    const projectId = document.getElementById("duct_project_id").value;
    fetch(`/submit_sheet/${projectId}`, {
      method: "POST"
    }).then(res => {
      if (res.ok) {
        alert("‚úÖ Sheet submitted!");
        closeDuctPopup();
        location.reload();
      }
    });
  }

  function setStatus(projectId, status) {
    fetch(`/set_status/${projectId}/${status}`, {
      method: "POST"
    }).then(res => {
      if (res.ok) location.reload();
    });
  }

  function approveProject(projectId) {
    fetch(`/approve_project/${projectId}`, {
      method: "POST"
    }).then(res => {
      if (res.ok) {
        alert("‚úÖ Project Approved!");
        location.reload();
      }
    });
  }
  </script>
  
  <!-- ===== Flash Messages (Toasts) ===== -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="toastContainer" style="position:fixed; top:20px; right:20px; z-index:99999;">
      {% for category, message in messages %}
        <div style="
            background: {{ 'green' if category == 'success' else 'red' }};
            color: white;
            padding: 12px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            min-width: 260px;
            font-weight: 500;
        ">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    <script>
      setTimeout(() => {
        const toastEl = document.getElementById("toastContainer");
        if (toastEl) toastEl.remove();
      }, 4000);
    </script>
  {% endif %}
{% endwith %} 

  <!-- === Add Project Popup === -->
<!-- ===== POPUP: Add New Project ===== -->
<div id="addProjectPopup" style="
  display:none; position:fixed; top:5%; left:50%; transform:translateX(-50%);
  background:#fff; padding:25px; border-radius:12px; width:450px;
  box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:10000;">
  
  <h3 style="margin-top:0; color:#2c3e50;">Add New Project</h3>
  <form id="addProjectForm" method="POST" action="/create_project" enctype="multipart/form-data">

    <!-- Vendor Dropdown -->
    <label>Vendor:</label>
    <select name="vendor_id" id="vendorDropdown" onchange="loadVendorInfo()" required style="width:100%; padding:8px;">
      <option value="">-- Select Vendor --</option>
      {% for vendor in vendors %}
        <option value="{{ vendor['id'] }}">{{ vendor['name'] }}</option>
      {% endfor %}
    </select><br><br>

    <label>GST:</label>
    <input type="text" id="vendor_gst" readonly style="width:100%; padding:8px;"><br><br>

    <label>Address:</label>
    <textarea id="vendor_address" readonly style="width:100%; padding:8px;"></textarea><br><br>

    <label>Quotation / RO Number:</label>
    <input type="text" name="quotation_ro" required style="width:100%; padding:8px;"><br><br>

    <label>Start Date:</label>
    <input type="date" name="start_date" required style="width:100%; padding:8px;"><br><br>

    <label>End Date:</label>
    <input type="date" name="end_date" required style="width:100%; padding:8px;"><br><br>

    <label>Location:</label>
    <input type="text" name="location" required style="width:100%; padding:8px;"><br><br>

    <label>Incharge:</label>
    <input type="text" name="incharge" required style="width:100%; padding:8px;"><br><br>

    <label>Notes:</label>
    <textarea name="notes" style="width:100%; padding:8px;"></textarea><br><br>

    <label>Attachment:</label>
    <input type="file" name="file" style="width:100%; padding:8px;"><br><br>

    <label>Enquiry ID:</label>
<input type="text" name="enquiry_id" value="{{ enquiry_id }}" readonly style="width:100%; padding:8px;">

    <div style="display:flex; justify-content:space-between;">
      <button type="submit" style="background:#2ecc71; color:white; padding:10px 20px; border:none; border-radius:6px;">Add</button>
      <button type="button" onclick="closeAddProject()" style="background:#e74c3c; color:white; padding:10px 20px; border:none; border-radius:6px;">Cancel</button>
    </div>
  </form>
</div>

  

<script>

  function openAddProject() {
  document.getElementById("addProjectPopup").style.display = "block";
}

function closeAddProject() {
  document.getElementById("addProjectPopup").style.display = "none";
}

function loadVendorInfo() {
  const vendorId = document.getElementById("vendorDropdown").value;
  if (!vendorId) {
    document.getElementById("vendor_gst").value = "";
    document.getElementById("vendor_address").value = "";
    return;
  }

  fetch(`/api/vendor/${vendorId}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("vendor_gst").value = data.gst || "";
      document.getElementById("vendor_address").value = data.address || "";
    });
}
  function openAddProject() {
    document.getElementById("addProjectPopup").style.display = "block";
  }
  function closeAddProjectPopup() {
    document.getElementById("addProjectPopup").style.display = "none";
  }
</script>
</body>
</html>
  
