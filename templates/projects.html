<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-label {
      font-weight: 600;
    }
    .modal-header {
      background-color: #0d6efd;
      color: white;
    }
    .modal-title {
      font-size: 18px;
    }
    .btn-custom {
      background-color: #0d6efd;
      color: white;
    }
    .btn-custom:hover {
      background-color: #0b5ed7;
    }
    .table th, .table td {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-4 text-center text-primary">Project Management</h3>
    <!-- üìå Add Project Button -->
    <div class="text-end mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
        ‚ûï Add Project
      </button>
    </div>

    <!-- üßæ Add Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="/add_project">
            <div class="modal-header">
              <h5 class="modal-title" id="addProjectModalLabel">‚ûï New Project Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3 px-3">

              <div class="col-md-6">
                <label class="form-label">Project Name</label>
                <input type="text" name="project_name" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Enquiry No</label>
                <input type="text" name="enquiry_no" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Office No</label>
                <input type="text" name="office_no" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Site Engineer</label>
                <input type="text" name="site_engineer" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Site Contact</label>
                <input type="text" name="site_contact" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input type="text" name="location" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" name="end_date" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Tag Drawing Upload</label>
                <input type="file" name="tag_drawing" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Notes</label>
                <textarea name="notes" class="form-control" rows="2"></textarea>
              </div>

              <div class="col-md-6">
                <label class="form-label">Project Incharge</label>
                <input type="text" name="project_incharge" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Select Vendor</label>
                <select name="vendor_id" class="form-select" onchange="fillVendorDetails(this)">
                  <option value="">-- Select --</option>
                  {% for vendor in vendors %}
                  <option value="{{ vendor.id }}">{{ vendor.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Vendor GST</label>
                <input type="text" id="vendor_gst" class="form-control" readonly>
              </div>

              <div class="col-md-6">
                <label class="form-label">Vendor Address</label>
                <textarea id="vendor_address" class="form-control" rows="2" readonly></textarea>
              </div>

            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">üì• Save Project</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      function fillVendorDetails(selectElement) {
        const selectedId = selectElement.value;
        const vendorData = {
          {% for vendor in vendors %}
          "{{ vendor.id }}": {
            gst: "{{ vendor.gst }}",
            address: "{{ vendor.address }}"
          },
          {% endfor %}
        };

        document.getElementById("vendor_gst").value = vendorData[selectedId]?.gst || '';
        document.getElementById("vendor_address").value = vendorData[selectedId]?.address || '';
      }
           </script>
<!-- üîç Search & Filter -->
    <div class="row mb-3">
      <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="üîç Search projects...">
      </div>
      <div class="col-md-6 text-end">
        <select id="statusFilter" class="form-select w-auto d-inline-block">
          <option value="">All Status</option>
          <option value="new">New</option>
          <option value="preparation">Preparation</option>
          <option value="under_review">Under Review</option>
          <option value="submitted for approval">Submitted for Approval</option>
          <option value="approved">Approved</option>
        </select>
      </div>
    </div>

    <!-- üìã Projects Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle" id="projectsTable">
        <thead class="table-dark">
          <tr>
            <th>Project ID</th>
            <th>Project Name</th>
            <th>Enquiry No</th>
            <th>Office No</th>
            <th>Site Engineer</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for project in projects %}
          <tr>
            <td>{{ project.id }}</td>
            <td>{{ project.project_name }}</td>
            <td>{{ project.enquiry_no }}</td>
            <td>{{ project.office_no }}</td>
            <td>{{ project.site_engineer }}</td>
            <td>
              {% if project.status == 'new' %}
                <span class="badge bg-warning text-dark">üÜï New</span>
              {% elif project.status == 'preparation' %}
                <span class="badge bg-primary">Preparation</span>
              {% elif project.status == 'under_review' %}
                <span class="badge bg-info text-dark">‚è≥ Under Review</span>
              {% elif project.status == 'submitted for approval' %}
                <span class="badge bg-secondary">üì§ Submitted</span>
              {% elif project.status == 'approved' %}
                <span class="badge bg-success">‚úÖ Approved</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ project.status }}</span>
              {% endif %}
            </td>
            <td>{{ project.timestamp }}</td>
            <td>
              <a href="/view_project/{{ project.id }}" class="btn btn-sm btn-outline-info">üëÅÔ∏è View</a>
              <a href="/edit_project/{{ project.id }}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è Edit</a>
              <a href="/delete_project/{{ project.id }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this project?')">üóëÔ∏è Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const tableRows = document.querySelectorAll('#projectsTable tbody tr');

      function filterTable() {
        const search = searchInput.value.toLowerCase();
        const status = statusFilter.value.toLowerCase();

        tableRows.forEach(row => {
          const text = row.innerText.toLowerCase();
          const rowStatus = row.children[5].innerText.toLowerCase();

          const matchesSearch = text.includes(search);
          const matchesStatus = !status || rowStatus.includes(status);

          row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        });
      }

      searchInput.addEventListener('input', filterTable);
      statusFilter.addEventListener('change', filterTable);
    </script>
<!-- üß≠ DESIGN PROCESS -->
    <div class="mt-5">
      <h5 class="text-primary">üß≠ Design Process</h5>

      <div class="d-flex flex-wrap gap-2">
        {% if project.status == 'new' %}
          <form method="POST" action="/submit_measurement/{{ project.id }}">
            <button class="btn btn-warning">üìã Save & Continue to Measurement Sheet</button>
          </form>

        {% elif project.status == 'preparation' %}
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#measurementSheetModal">
            üìê Measurement Sheet
          </button>
          <form method="POST" action="/submit_for_review/{{ project.id }}">
            <button class="btn btn-secondary">üöß Submit for Review</button>
          </form>

        {% elif project.status == 'under_review' %}
          <span class="badge bg-info text-dark p-2">‚è≥ Under Review</span>

        {% elif project.status == 'submitted for approval' %}
          <form method="POST" action="/approve_project/{{ project.id }}">
            <button class="btn btn-success">‚úÖ Approve Project</button>
          </form>

        {% elif project.status == 'approved' %}
          <span class="badge bg-success p-2">üéØ Approved</span>

        {% else %}
          <span class="badge bg-secondary p-2">‚öôÔ∏è {{ project.status }}</span>
        {% endif %}
      </div>
    </div>

    <!-- üìê MEASUREMENT SHEET POPUP -->
    <div class="modal fade" id="measurementSheetModal" tabindex="-1" aria-labelledby="measurementSheetLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <form method="POST" action="/add_duct">
            <div class="modal-header">
              <h5 class="modal-title text-primary" id="measurementSheetLabel">üìê Measurement Sheet - Project ID {{ project.id }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="project_id" value="{{ project.id }}">

              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Duct No</label>
                  <input type="text" name="duct_no" class="form-control" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Duct Type</label>
                  <select name="duct_type" class="form-select" required>
                    <option value="ST">ST</option>
                    <option value="RED">RED</option>
                    <option value="OFFSET">OFFSET</option>
                    <option value="SHOE">SHOE</option>
                    <option value="DUM">DUM</option>
                    <option value="VANES">VANES</option>
                    <option value="ELB">ELB</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Width 1 (mm)</label>
                  <input type="number" name="width1" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Height 1 (mm)</label>
                  <input type="number" name="height1" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Width 2 (mm)</label>
                  <input type="number" name="width2" class="form-control">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Height 2 (mm)</label>
                  <input type="number" name="height2" class="form-control">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Length/Radius</label>
                  <input type="number" name="length_or_radius" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Qty</label>
                  <input type="number" name="quantity" class="form-control" required>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Degree/Offset</label>
                  <input type="number" name="degree_or_offset" class="form-control">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Factor</label>
                  <input type="number" name="factor" step="0.01" class="form-control">
                </div>
              </div> <!-- end row -->
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-success">üíæ Save Entry</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </form>
        </div>
      </div>
    </div>
<!-- üìä LIVE DUCT ENTRIES TABLE -->
    <div class="mt-5">
      <h5 class="text-primary">üìä Duct Entries</h5>

      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Duct No</th>
              <th>Type</th>
              <th>W1</th>
              <th>H1</th>
              <th>W2</th>
              <th>H2</th>
              <th>Len/Rad</th>
              <th>Qty</th>
              <th>Deg/Off</th>
              <th>Factor</th>
              <th>Gauge</th>
              <th>Area (m¬≤)</th>
              <th>Nuts</th>
              <th>Cleat</th>
              <th>Gasket (m)</th>
              <th>Corner</th>
              <th>üõ†Ô∏è Action</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in entries %}
            <tr>
              <td>{{ entry[2] }}</td>
              <td>{{ entry[3] }}</td>
              <td>{{ entry[4] }}</td>
              <td>{{ entry[5] }}</td>
              <td>{{ entry[6] }}</td>
              <td>{{ entry[7] }}</td>
              <td>{{ entry[8] }}</td>
              <td>{{ entry[9] }}</td>
              <td>{{ entry[10] }}</td>
              <td>{{ entry[11] }}</td>
              <td>{{ entry[12] }}</td>
              <td>{{ "%.2f"|format(entry[13]) }}</td>
              <td>{{ entry[14] }}</td>
              <td>{{ entry[15] }}</td>
              <td>{{ "%.2f"|format(entry[16]) }}</td>
              <td>{{ entry[17] }}</td>
              <td>
                <a href="/edit/{{ entry[0] }}" class="btn btn-sm btn-primary">‚úèÔ∏è Edit</a>
                <a href="/delete/{{ entry[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this entry?')">üóëÔ∏è</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light fw-bold">
            <tr>
              <td colspan="7">Total</td>
              <td>{{ total_qty }}</td>
              <td colspan="3"></td>
              <td>{{ "%.2f"|format(total_area) }}</td>
              <td>{{ total_bolts }}</td>
              <td>{{ total_cleat }}</td>
              <td>{{ "%.2f"|format(total_gasket) }}</td>
              <td>{{ total_corner }}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
<!-- üì§ EXPORT & SUBMIT -->
    <div class="mt-4 d-flex flex-wrap gap-3 align-items-center">
      <form method="GET" action="/export_excel/{{ project_id }}">
        <button class="btn btn-success">üìä Export to Excel</button>
      </form>

      <form method="GET" action="/export_pdf/{{ project_id }}">
        <button class="btn btn-danger">üßæ Export to PDF</button>
      </form>

      <form method="POST" action="/submit_all/{{ project_id }}">
        <button class="btn btn-primary">‚úÖ Final Submit</button>
      </form>
    </div>

    <!-- üßÆ AREA BY GAUGE -->
    <div class="mt-4">
      <h6 class="text-secondary">Area Summary by Gauge</h6>
      <table class="table table-bordered table-sm w-auto text-center">
        <thead class="table-light">
          <tr>
            <th>Gauge</th>
            <th>Area (m¬≤)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>24g</td><td>{{ "%.2f"|format(area_24g) }}</td></tr>
          <tr><td>22g</td><td>{{ "%.2f"|format(area_22g) }}</td></tr>
          <tr><td>20g</td><td>{{ "%.2f"|format(area_20g) }}</td></tr>
          <tr><td>18g</td><td>{{ "%.2f"|format(area_18g) }}</td></tr>
        </tbody>
      </table>
    </div>
</div> <!-- End of .container -->
  </div> <!-- End of main content wrapper -->

  <!-- ‚úÖ BOOTSTRAP & JQUERY SCRIPTS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
          integrity="sha256-/xUj+3OJ+Y3Jd5yR1yYYz1EFydbbRVjKJvMZY43JCjM="
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-ENjdO4Dr2bkBIFxQpeoYz1DhF0snqF4F5lZlPYz0vZlKqfJ1jG1tvnXWl5mX04yS"
          crossorigin="anonymous"></script>

  <!-- üîÅ AUTO-FILL VENDOR DETAILS ON SELECTION -->
  <script>
    $(document).ready(function () {
      $('#vendorSelect').on('change', function () {
        const selected = $(this).find(':selected');
        $('#vendorAddress').val(selected.data('address') || '');
        $('#vendorGst').val(selected.data('gst') || '');
      });
    });
  </script>

</body>
</html>

    
