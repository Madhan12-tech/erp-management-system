<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
    }
    .table th, .table td {
      vertical-align: middle;
    }
  </style>
</head>
<body>

<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Project Management</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">‚ûï Add Project</button>
  </div>

  <!-- ‚úÖ Add Project Modal -->
  <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="/save_project">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addProjectModalLabel">Add New Project</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">

            <div class="mb-2">
              <label>Project Name</label>
              <input type="text" name="project_name" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Enquiry No</label>
              <input type="text" name="enquiry_no" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Office No</label>
              <input type="text" name="office_no" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Site Engineer</label>
              <input type="text" name="site_engineer" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Contact Number</label>
              <input type="text" name="site_contact" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>Location</label>
              <input type="text" name="location" class="form-control" required>
            </div>

          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save Project</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% for project in projects %}
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>{{ project.project_name }}</strong>
      <span class="text-light small">üìÖ {{ project.timestamp }}</span>
    </div>
    <div class="card-body">

      <p>
        <strong>Enquiry No:</strong> {{ project.enquiry_no }} |
        <strong>Office No:</strong> {{ project.office_no }} |
        <strong>Engineer:</strong> {{ project.site_engineer }} |
        <strong>Contact:</strong> {{ project.site_contact }} |
        <strong>Location:</strong> {{ project.location }}
      </p>

      <!-- üß≠ DESIGN PROCESS STAGES -->
      <div class="mt-3">
        <h5 class="text-primary">üß≠ Design Process</h5>
        <div class="d-flex flex-wrap gap-2">

          {% if project.status == 'new' %}
            <form method="POST" action="/submit_measurement/{{ project.id }}">
              <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#measurementModal{{ project.id }}">
                üìã Start Measurement Sheet
              </button>
            </form>

          {% elif project.status == 'preparation' %}
            <form method="POST" action="/submit_for_review/{{ project.id }}">
              <button class="btn btn-secondary">üöß Submit for Review</button>
            </form>

          {% elif project.status == 'under_review' %}
            <span class="badge bg-info text-dark p-2">‚è≥ Under Review</span>

          {% elif project.status == 'submitted for approval' %}
            <form method="POST" action="/approve_project/{{ project.id }}">
              <button class="btn btn-success">‚úÖ Approve Project</button>
            </form>

          {% elif project.status == 'approved' %}
            <span class="badge bg-success p-2">üéØ Approved</span>

          {% else %}
            <span class="badge bg-secondary p-2">‚öôÔ∏è {{ project.status }}</span>
          {% endif %}

        </div>
      </div>

      <!-- üìã Measurement Sheet Modal -->
      <div class="modal fade" id="measurementModal{{ project.id }}" tabindex="-1" aria-labelledby="measurementModalLabel{{ project.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <form method="POST" action="/submit_sheet/{{ project.id }}">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="measurementModalLabel{{ project.id }}">üìê Measurement Sheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">

                <div class="row g-3">
                  <div class="col-md-6">
                    <label>Duct No</label>
                    <input type="text" name="duct_no" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label>Type</label>
                    <select name="duct_type" class="form-select" required>
                      <option value="">-- Select --</option>
                      <option value="ST">ST</option>
                      <option value="RED">RED</option>
                      <option value="DUM">DUM</option>
                      <option value="OFFSET">OFFSET</option>
                      <option value="SHOE">SHOE</option>
                      <option value="VANES">VANES</option>
                      <option value="ELB">ELB</option>
                    </select>
                  </div>
                  <div class="col-md-3"><label>W1</label><input type="number" name="width1" class="form-control" required></div>
                  <div class="col-md-3"><label>H1</label><input type="number" name="height1" class="form-control" required></div>
                  <div class="col-md-3"><label>W2</label><input type="number" name="width2" class="form-control"></div>
                  <div class="col-md-3"><label>H2</label><input type="number" name="height2" class="form-control"></div>
                  <div class="col-md-4"><label>Length/Radius</label><input type="number" name="length_or_radius" class="form-control" required></div>
                  <div class="col-md-4"><label>Qty</label><input type="number" name="quantity" class="form-control" required></div>
                  <div class="col-md-4"><label>Deg/Offset</label><input type="number" name="degree_or_offset" class="form-control"></div>
                </div>

              </div>
              <div class="modal-footer">
                <button type="submit" formaction="/submit_sheet/{{ project.id }}" class="btn btn-success">Save & Continue</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- ‚ûï Duct Entry Button -->
      <div class="mt-3">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#ductEntryModal{{ project.id }}">
          ‚ûï Add Duct Entry
        </button>
      </div>

      <!-- üìä LIVE DUCT TABLE (Right Side Table with Full Fields) -->
      <div class="table-responsive mt-3">
        <table class="table table-bordered table-sm text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>Duct No</th>
              <th>Type</th>
              <th>W1</th>
              <th>H1</th>
              <th>W2</th>
              <th>H2</th>
              <th>Len/Rad</th>
              <th>Qty</th>
              <th>Deg/Off</th>
              <th>Gauge</th>
              <th>24g</th>
              <th>22g</th>
              <th>20g</th>
              <th>18g</th>
              <th>Area</th>
              <th>Nuts & Bolts</th>
              <th>Cleat</th>
              <th>Gasket</th>
              <th>Corner Pieces</th>
            </tr>
          </thead>
          <tbody>
            {% for duct in project.ducts %}
            <tr>
              <td>{{ duct.duct_no }}</td>
              <td>{{ duct.duct_type }}</td>
              <td>{{ duct.width1 }}</td>
              <td>{{ duct.height1 }}</td>
              <td>{{ duct.width2 }}</td>
              <td>{{ duct.height2 }}</td>
              <td>{{ duct.length_or_radius }}</td>
              <td>{{ duct.quantity }}</td>
              <td>{{ duct.degree_or_offset }}</td>
              <td>{{ duct.gauge }}</td>
              <td>{% if duct.gauge == '24g' %}{{ duct.area }}{% endif %}</td>
              <td>{% if duct.gauge == '22g' %}{{ duct.area }}{% endif %}</td>
              <td>{% if duct.gauge == '20g' %}{{ duct.area }}{% endif %}</td>
              <td>{% if duct.gauge == '18g' %}{{ duct.area }}{% endif %}</td>
              <td>{{ duct.area }}</td>
              <td>{{ duct.nuts_bolts }}</td>
              <td>{{ duct.cleat }}</td>
              <td>{{ duct.gasket }}</td>
              <td>{{ duct.corner_pieces }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- üì§ EXPORT BUTTONS -->
      <div class="mt-3 d-flex flex-wrap gap-2">
        <a href="/export_excel/{{ project.id }}" class="btn btn-success">üìÅ Export to Excel</a>
        <a href="/export_pdf/{{ project.id }}" class="btn btn-danger">üñ®Ô∏è Export to PDF</a>
        <form method="POST" action="/submit_all/{{ project.id }}">
          <button type="submit" class="btn btn-primary">üì§ Submit All</button>
        </form>
      </div>

      <!-- üßæ Duct Entry Modal -->
      <div class="modal fade" id="ductEntryModal{{ project.id }}" tabindex="-1" aria-labelledby="ductEntryLabel{{ project.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <form method="POST" action="/add_duct">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">‚ûï Duct Entry for {{ project.project_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" name="project_id" value="{{ project.id }}">
                <div class="row g-3">
                  <div class="col-md-6"><label>Duct No</label><input type="text" name="duct_no" class="form-control" required></div>
                  <div class="col-md-6">
                    <label>Duct Type</label>
                    <select name="duct_type" class="form-select" required>
                      <option value="">-- Select --</option>
                      <option value="ST">ST</option>
                      <option value="RED">RED</option>
                      <option value="DUM">DUM</option>
                      <option value="OFFSET">OFFSET</option>
                      <option value="SHOE">SHOE</option>
                      <option value="VANES">VANES</option>
                      <option value="ELB">ELB</option>
                    </select>
                  </div>
                  <div class="col-md-3"><label>W1</label><input type="number" step="any" name="width1" class="form-control" required></div>
                  <div class="col-md-3"><label>H1</label><input type="number" step="any" name="height1" class="form-control" required></div>
                  <div class="col-md-3"><label>W2</label><input type="number" step="any" name="width2" class="form-control"></div>
                  <div class="col-md-3"><label>H2</label><input type="number" step="any" name="height2" class="form-control"></div>
                  <div class="col-md-4"><label>Length/Radius</label><input type="number" step="any" name="length_or_radius" class="form-control" required></div>
                  <div class="col-md-4"><label>Qty</label><input type="number" name="quantity" class="form-control" required></div>
                  <div class="col-md-4"><label>Degree/Offset</label><input type="number" step="any" name="degree_or_offset" class="form-control"></div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-success">‚úÖ Add Duct</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Cancel</button>
              </div>
            </div>
          </form>
        </div>
      </div>

    </div> <!-- end card-body -->
  </div> <!-- end card -->
  {% endfor %}
  </div> <!-- End container -->
  </div> <!-- End content -->

  <!-- ‚úÖ Bootstrap 5 JS and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ‚úÖ Optional: Toast Notifications (Bootstrap 5) -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
        {% for message in messages %}
          <div class="toast show align-items-center text-bg-success border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body">
                {{ message }}
              </div>
              <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

</body>
</html>

  
