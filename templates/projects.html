<!-- templates/projects.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; }
    .modal-lg { max-width: 90% !important; }
    .status-badge { font-size: 0.9em; padding: 4px 8px; border-radius: 5px; }
    .status-new { background-color: #e3f2fd; color: #0d6efd; }
    .status-preparation { background-color: #fff3cd; color: #856404; }
    .status-under_review { background-color: #d1ecf1; color: #0c5460; }
    .status-approved { background-color: #d4edda; color: #155724; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center">
    <h2>Projects</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProjectModal">+ New Project</button>
  </div>

  <!-- Success Message -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- üîÑ Design Process -->
  <div class="mt-4">
    <h5 class="mb-3">üìê Design Process</h5>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
      {% for project in projects %}
      <div class="col">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h6>{{ project.quotation_ro }} | {{ project.client_name or 'Client' }}</h6>
            <p class="text-muted mb-1">{{ project.site_location or 'Location' }}</p>
            <span class="badge status-badge status-{{ project.status.replace(' ', '_') }}">{{ project.status|capitalize }}</span>

            {% if project.status == 'new' %}
              <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#measurementModal{{ project.id }}">Start Measurement</button>
            {% elif project.status == 'preparation' %}
              <form action="/submit_for_review/{{ project.id }}" method="POST" class="mt-2">
                <button class="btn btn-sm btn-warning">Submit for Review</button>
              </form>
            {% elif project.status == 'under_review' %}
              <form action="/approve_project/{{ project.id }}" method="POST" class="mt-2">
                <button class="btn btn-sm btn-success">Approve</button>
              </form>
            {% elif project.status == 'approved' %}
              <a href="/production/{{ project.id }}" class="btn btn-sm btn-outline-success mt-2">Go to Production</a>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- üìù Measurement Sheet Modal -->
  {% for project in projects %}
  <div class="modal fade" id="measurementModal{{ project.id }}" tabindex="-1" aria-labelledby="measurementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="POST" action="/add_measurement">
          <div class="modal-header">
            <h5 class="modal-title">Measurement Sheet ‚Äì {{ project.quotation_ro }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body row g-3 px-3">
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <div class="col-md-6">
              <label>Client Name</label>
              <input type="text" class="form-control" name="client_name" required>
            </div>
            <div class="col-md-6">
              <label>Site Location</label>
              <input type="text" class="form-control" name="site_location" required>
            </div>
            <div class="col-md-6">
              <label>Engineer Name</label>
              <input type="text" class="form-control" name="engineer_name" required>
            </div>
            <div class="col-md-6">
              <label>Mobile</label>
              <input type="text" class="form-control" name="mobile" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save & Continue</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- üìã Duct Entry Form -->
<div class="card mt-4 shadow-sm border-0">
  <div class="card-body">
    <h5 class="card-title">‚ûï Add Duct Entry</h5>
    <form id="ductForm" method="POST" action="/add_duct">
      <input type="hidden" name="project_id" id="duct_project_id">
      <div class="row g-3">

        <div class="col-md-3">
          <label>Type</label>
          <select class="form-select" name="type" required>
            <option value="">Select</option>
            <option value="Straight">Straight</option>
            <option value="Elbow">Elbow</option>
            <option value="Tee">Tee</option>
            <option value="Reducer">Reducer</option>
            <option value="Offset">Offset</option>
          </select>
        </div>

        <div class="col-md-2">
          <label>W1</label>
          <input type="number" step="0.01" name="w1" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label>H1</label>
          <input type="number" step="0.01" name="h1" class="form-control" required>
        </div>
        <div class="col-md-2">
          <label>W2</label>
          <input type="number" step="0.01" name="w2" class="form-control">
        </div>
        <div class="col-md-2">
          <label>H2</label>
          <input type="number" step="0.01" name="h2" class="form-control">
        </div>

        <div class="col-md-2">
          <label>Length/Radius</label>
          <input type="number" step="0.01" name="length_radius" class="form-control" required>
        </div>

        <div class="col-md-2">
          <label>Qty</label>
          <input type="number" name="quantity" class="form-control" required>
        </div>

        <div class="col-md-2">
          <label>Offset ¬∞</label>
          <input type="text" name="offset_degree" class="form-control">
        </div>

        <div class="col-md-2">
          <label>Gauge</label>
          <select name="gauge" class="form-select" required>
            <option value="">Select</option>
            <option value="22">22</option>
            <option value="24">24</option>
            <option value="26">26</option>
            <option value="28">28</option>
          </select>
        </div>

        <div class="col-md-2">
          <label>Area (sqm)</label>
          <input type="number" step="0.01" name="area" class="form-control" required>
        </div>

        <div class="col-md-2 mt-4">
          <button type="submit" class="btn btn-success mt-2 w-100">Add</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- üìä Live Duct Table -->
<div class="card mt-4 shadow-sm border-0">
  <div class="card-body">
    <h5 class="card-title">üìÑ Live Duct Entries</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Type</th>
            <th>W1</th>
            <th>H1</th>
            <th>W2</th>
            <th>H2</th>
            <th>Length/Radius</th>
            <th>Qty</th>
            <th>Offset¬∞</th>
            <th>Gauge</th>
            <th>Area</th>
            <th>‚ùå</th>
          </tr>
        </thead>
        <tbody>
          {% for duct in project.ducts %}
          <tr>
            <td>{{ duct.type }}</td>
            <td>{{ duct.w1 }}</td>
            <td>{{ duct.h1 }}</td>
            <td>{{ duct.w2 }}</td>
            <td>{{ duct.h2 }}</td>
            <td>{{ duct.length_radius }}</td>
            <td>{{ duct.quantity }}</td>
            <td>{{ duct.offset_degree }}</td>
            <td>{{ duct.gauge }}</td>
            <td>{{ duct.area }}</td>
            <td>
              <form method="POST" action="/delete_duct/{{ duct.id }}" onsubmit="return confirm('Delete this entry?');">
                <button class="btn btn-sm btn-outline-danger">üóë</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- üì§ Export Button -->
    <div class="mt-3 text-end">
      <a href="/export_excel/{{ project.id }}" class="btn btn-outline-primary">Export to Excel</a>
    </div>
  </div>
</div>

  <!-- üö¶ Final Design Stage Controls -->
<div class="card mt-4 border-0 shadow-sm">
  <div class="card-body">
    <h5 class="card-title">üßæ Final Actions</h5>

    <!-- üîò Status Based Button Group -->
    <form method="POST" action="/submit_for_review/{{ project.id }}" class="d-inline">
      {% if project.status == 'preparation' %}
      <button type="submit" class="btn btn-warning">üì§ Submit for Review</button>
      {% endif %}
    </form>

    <form method="POST" action="/submit_measurement/{{ project.id }}" class="d-inline">
      {% if project.status == 'under_review' %}
      <button type="submit" class="btn btn-primary">üì§ Submit for Approval</button>
      {% endif %}
    </form>

    <form method="POST" action="/approve_project/{{ project.id }}" class="d-inline">
      {% if project.status == 'submitted for approval' %}
      <button type="submit" class="btn btn-success">‚úÖ Approve</button>
      {% endif %}
    </form>

    <!-- üóë Project Delete -->
    <form method="POST" action="/project/{{ project.id }}/delete" class="d-inline ms-2" onsubmit="return confirm('Delete this project permanently?')">
      <button class="btn btn-outline-danger">üóë Delete Project</button>
    </form>

    <!-- üìå Project Summary Modal Trigger -->
    <button type="button" class="btn btn-outline-dark float-end" data-bs-toggle="modal" data-bs-target="#summaryModal">
      üìä View Summary
    </button>
  </div>
</div>

<!-- üìã Summary Modal -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üìä Project Summary</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Vendor:</strong> {{ project.vendor_name }}</p>
        <p><strong>Client:</strong> {{ project.client_name }}</p>
        <p><strong>Site Location:</strong> {{ project.site_location }}</p>
        <p><strong>Engineer:</strong> {{ project.engineer_name }} | {{ project.mobile }}</p>
        <p><strong>Status:</strong> {{ project.status }}</p>
        <p><strong>Total Duct Area:</strong> {{ project.total_sqm or 0 }} sqm</p>
        <!-- Add more info as needed -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

  </div> <!-- End container-fluid -->
  </main>
</div> <!-- End main row -->

<!-- ‚úÖ Bootstrap & jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ‚úÖ Custom JS -->
<script>
  $(document).ready(function () {
    // Autofill vendor GST and address
    $('#vendor_id').change(function () {
      var vendorId = $(this).val();
      if (vendorId) {
        $.get('/api/vendor/' + vendorId, function (data) {
          $('#gst').val(data.gst);
          $('#address').val(data.address);
        });
      }
    });

    // Save Measurement Sheet and show duct section
    $('#saveMeasurementBtn').click(function () {
      $.post("/add_measurement", $('#measurementForm').serialize())
        .done(function () {
          $('#measurementModal').modal('hide');
          $('#ductSection').removeClass('d-none');
        });
    });

    // Save Duct Entry
    $('#addDuctBtn').click(function () {
      $.post("/add_duct", $('#ductForm').serialize())
        .done(function () {
          $('#ductForm')[0].reset();
          loadDucts();
        });
    });

    // Delete Duct Entry
    $(document).on('click', '.delete-duct', function () {
      var id = $(this).data('id');
      $.post('/delete_duct/' + id)
        .done(function () {
          loadDucts();
        });
    });

    // Load Duct Entries
    function loadDucts() {
      var projectId = $('#project_id').val();
      $.getJSON('/api/ducts/' + projectId, function (data) {
        let rows = '';
        data.forEach(function (item, index) {
          rows += `
            <tr>
              <td>${index + 1}</td>
              <td>${item.type}</td>
              <td>${item.w1 || '-'} x ${item.h1 || '-'}</td>
              <td>${item.w2 || '-'} x ${item.h2 || '-'}</td>
              <td>${item.length_radius || '-'}</td>
              <td>${item.quantity}</td>
              <td>${item.offset_degree || '-'}</td>
              <td>${item.gauge || '-'}</td>
              <td>${item.area || '0'}</td>
              <td><button class="btn btn-sm btn-danger delete-duct" data-id="${item.id}">üóë</button></td>
            </tr>
          `;
        });
        $('#ductTableBody').html(rows);
      });
    }

    // Initial load if duct section visible
    if (!$('#ductSection').hasClass('d-none')) {
      loadDucts();
    }
  });
</script>

</body>
</html>

  

  

  
