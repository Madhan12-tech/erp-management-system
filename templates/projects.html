<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projects | Ducting ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .form-label {
      font-weight: 500;
    }
    .table th, .table td {
      vertical-align: middle;
      text-align: center;
    }
    .modal-header {
      background-color: #0d6efd;
      color: white;
    }
    .status-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 5px;
    }
    .status-submitted { background-color: #ffc107; color: #000; }
    .status-review { background-color: #0dcaf0; color: #000; }
    .status-approved { background-color: #198754; color: #fff; }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Ducting Projects Management</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vendorProjectModal">+ Add Project</button>
  </div>

  <!-- First Popup: Vendor & Project Info -->
<div class="modal fade" id="vendorProjectModal" tabindex="-1" aria-labelledby="vendorProjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <form class="modal-content" method="post" action="{{ url_for('create_project') }}" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title" id="vendorProjectModalLabel">Add New Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-2">

        <div class="col-md-6">
          <label class="form-label">Vendor Name</label>
          <select name="vendor_id" id="vendor_id" class="form-select" required onchange="fillVendorDetails(this)">
            <option value="">Select Vendor</option>
            {% for vendor in vendors %}
              <option value="{{ vendor[0] }}">{{ vendor[1] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Vendor GST No</label>
          <input type="text" name="vendor_gst" id="vendor_gst" class="form-control" readonly>
        </div>

        <div class="col-12">
          <label class="form-label">Vendor Address</label>
          <textarea name="vendor_address" id="vendor_address" class="form-control" rows="2" readonly></textarea>
        </div>

        <div class="col-md-6">
          <label class="form-label">Project Location</label>
          <input type="text" name="project_location" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Drawing Upload</label>
          <input type="file" name="drawing_file" class="form-control" accept=".pdf,.jpg,.png,.jpeg">
        </div>

        <div class="col-12">
          <label class="form-label">Project Notes</label>
          <textarea name="project_notes" class="form-control" rows="2" placeholder="Optional"></textarea>
        </div>

      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Save & Continue</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  const vendorData = {
    {% for vendor in vendors %}
      {{ vendor[0] }}: {
        gst: "{{ vendor[2] }}",
        address: "{{ vendor[3] }}"
      },
    {% endfor %}
  };

  function fillVendorDetails(select) {
    const id = select.value;
    document.getElementById('vendor_gst').value = vendorData[id]?.gst || '';
    document.getElementById('vendor_address').value = vendorData[id]?.address || '';
  }
</script>

  <!-- Second Popup: Measurement Sheet Info -->
{% for project in projects %}
    <div class="modal fade" id="measurementModal{{ project.id }}" tabindex="-1" aria-labelledby="measurementModalLabel{{ project.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <form method="post" action="{{ url_for('measurement_entry', project_id=project.id) }}">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Measurement Sheet - {{ project.project_name }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="client_name{{ project.id }}" class="form-label">Client Name</label>
                <input type="text" class="form-control" name="client_name" required>
              </div>
              <div class="mb-3">
                <label for="site_engineer{{ project.id }}" class="form-label">Site Engineer</label>
                <input type="text" class="form-control" name="site_engineer" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-success">Save Measurement</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    {% endfor %}

  <!-- Duct Entry Section -->
<div class="container-fluid mt-4" id="ductEntrySection" style="display: none;">
  <!-- Header showing selected details -->
  <div class="alert alert-secondary d-flex justify-content-between align-items-center">
    <div>
      <strong>Client:</strong> <span id="clientNameDisplay"></span> |
      <strong>Location:</strong> <span id="projectLocationDisplay"></span> |
      <strong>Engineer:</strong> <span id="siteEngineerDisplay"></span>
    </div>
    <div>
      <a href="#" class="btn btn-sm btn-success">Export Excel</a>
      <a href="#" class="btn btn-sm btn-danger">Export PDF</a>
      <button onclick="window.print()" class="btn btn-sm btn-outline-primary">Print</button>
    </div>
  </div>

  <div class="row">
    <!-- Duct Entry Form -->
    <div class="col-md-4">
      <form method="POST" action="{{ url_for('add_duct') }}">
        <input type="hidden" name="project_id" value="{{ project_id }}">

        <div class="mb-2">
          <label class="form-label">Duct No</label>
          <input type="text" name="duct_no" class="form-control" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Type</label>
          <select name="duct_type" class="form-control" required>
            <option value="ST">ST</option>
            <option value="RED">RED</option>
            <option value="DUM">DUM</option>
            <option value="OFFSET">OFFSET</option>
            <option value="SHOE">SHOE</option>
            <option value="VANES">VANES</option>
            <option value="ELB">ELB</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Width1</label>
          <input type="number" name="width1" class="form-control" step="0.01" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Height1</label>
          <input type="number" name="height1" class="form-control" step="0.01" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Width2</label>
          <input type="number" name="width2" class="form-control" step="0.01">
        </div>

        <div class="mb-2">
          <label class="form-label">Height2</label>
          <input type="number" name="height2" class="form-control" step="0.01">
        </div>

        <div class="mb-2">
          <label class="form-label">Length/Radius</label>
          <input type="number" name="length_or_radius" class="form-control" step="0.01" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Quantity</label>
          <input type="number" name="quantity" class="form-control" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Offset/Degree</label>
          <input type="number" name="degree_or_offset" class="form-control" step="0.01">
        </div>

        <div class="mb-2">
          <label class="form-label">Factor</label>
          <input type="number" name="factor" class="form-control" step="0.1" value="1.0">
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-2">Add Entry</button>
      </form>
    </div>

    <!-- Live Table -->
    <div class="col-md-8">
      <table class="table table-bordered table-striped table-sm">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Duct</th>
            <th>Type</th>
            <th>W1</th>
            <th>H1</th>
            <th>W2</th>
            <th>H2</th>
            <th>Len</th>
            <th>Qty</th>
            <th>Offset</th>
            <th>Gauge</th>
            <th>Area</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in duct_entries %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ entry[2] }}</td>
            <td>{{ entry[3] }}</td>
            <td>{{ entry[4] }}</td>
            <td>{{ entry[5] }}</td>
            <td>{{ entry[6] }}</td>
            <td>{{ entry[7] }}</td>
            <td>{{ entry[8] }}</td>
            <td>{{ entry[9] }}</td>
            <td>{{ entry[10] }}</td>
            <td>{{ entry[11] }}</td>
            <td>{{ entry[12] }}</td>
            <td>
              <a href="{{ url_for('edit_duct', id=entry[0]) }}" class="btn btn-sm btn-warning">Edit</a>
              <a href="{{ url_for('delete_duct', id=entry[0]) }}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this entry?')">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Sheet Actions -->
      <div class="d-flex justify-content-end mt-2">
      <form method="POST" action="{{ url_for('submit_measurement', project_id=project.id) }}">
          <button type="submit" class="btn btn-warning">Submit Sheet</button>
        </form>
      </div>
    </div>
  </div>
</div>

  <!-- JavaScript to Handle Popups and Auto-fill -->
<script>
  function openMeasurementPopup() {
    const measurementModal = new bootstrap.Modal(document.getElementById('measurementPopup'));
    measurementModal.show();
  }

  function continueToSheetPopup() {
    // Auto fill top row of duct entry section
    document.getElementById("clientNameDisplay").innerText = document.getElementById("client_name").value;
    document.getElementById("projectLocationDisplay").innerText = document.getElementById("project_location").value;
    document.getElementById("siteEngineerDisplay").innerText = document.getElementById("site_engineer").value;

    const sheetModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('measurementPopup'));
    sheetModal.hide();

    document.getElementById("ductEntrySection").style.display = "block";
  }

  function fillVendorDetails() {
    const vendorInfo = {
      {% for vendor in vendors %}
        "{{ vendor[1] }}": {
          gst: "{{ vendor[2] }}",
          address: "{{ vendor[3] }}"
        },
      {% endfor %}
    };

    const selectedVendor = document.getElementById("vendor").value;
    if (vendorInfo[selectedVendor]) {
      document.getElementById("gst").value = vendorInfo[selectedVendor].gst;
      document.getElementById("address").value = vendorInfo[selectedVendor].address;
    } else {
      document.getElementById("gst").value = "";
      document.getElementById("address").value = "";
    }
  }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

  
