<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f9f9f9;
      font-family: 'Segoe UI', sans-serif;
    }
    .modal-header {
      background-color: #007bff;
      color: white;
    }
    .modal-footer button {
      min-width: 100px;
    }
    .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<div class="container py-4">
  <h2 class="mb-4 text-primary">ğŸ“ Project Management</h2>

  <!-- âœ… ADD PROJECT BUTTON -->
  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addProjectModal">
    â• Add New Project
  </button>

  <!-- âœ… PROJECTS TABLE -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover bg-white">
      <thead class="table-light">
        <tr>
          <th>Project Name</th>
          <th>Vendor</th>
          <th>Enquiry No</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for project in projects %}
        <tr>
          <td>{{ project.project_name }}</td>
          <td>{{ project.vendor_name }}</td>
          <td>{{ project.enquiry_no }}</td>
          <td>{{ project.start_date }}</td>
          <td>{{ project.end_date }}</td>
          <td>{{ project.status }}</td>
          <td>
            <a href="/project/{{ project.id }}" class="btn btn-sm btn-info">Open</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- âœ… DESIGN PROCESS SECTION -->
  {% if project %}
  <hr>
  <h5 class="mt-4 text-primary">ğŸ§­ Design Process</h5>
  <div class="d-flex flex-wrap gap-2">

    {% if project.status == 'new' %}
      <button class="btn btn-warning" id="saveAndOpenModal" data-project="{{ project.id }}">
  ğŸ“‹ Save & Continue to Measurement Sheet
      </button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#measurementSheetModal"
  {% if project.status != 'preparation' %} disabled {% endif %}>
  ğŸ“ Measurement Sheet
      </button>
      <form method="POST" action="/submit_for_review/{{ project.id }}">
        <button class="btn btn-secondary">ğŸš§ Submit for Review</button>
      </form>

    {% elif project.status == 'under_review' %}
      <span class="badge bg-info text-dark p-2">â³ Under Review</span>

    {% elif project.status == 'submitted for approval' %}
      <form method="POST" action="/approve_project/{{ project.id }}">
        <button class="btn btn-success">âœ… Approve Project</button>
      </form>

    {% elif project.status == 'approved' %}
      <span class="badge bg-success p-2">ğŸ¯ Approved</span>

    {% else %}
      <span class="badge bg-secondary p-2">âš™ï¸ {{ project.status }}</span>
    {% endif %}
  </div>
  {% endif %}

  <!-- âœ… RIGHT-SIDE LIVE DUCT TABLE (if project exists) -->
  {% if project %}
  <div class="mt-4">
    <h5>ğŸ“Š Duct Entries</h5>
    <div class="table-responsive">
      <table class="table table-sm table-bordered bg-white">
        <thead class="table-secondary">
          <tr>
            <th>Duct No</th><th>Type</th><th>W1</th><th>H1</th><th>W2</th><th>H2</th>
            <th>Len/Rad</th><th>Qty</th><th>Deg/Off</th><th>Gauge</th><th>Area</th>
            <th>Nuts</th><th>Cleat</th><th>Gasket</th><th>Corner</th><th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in entries %}
          <tr>
            <td>{{ entry.duct_no }}</td>
            <td>{{ entry.duct_type }}</td>
            <td>{{ entry.width1 }}</td>
            <td>{{ entry.height1 }}</td>
            <td>{{ entry.width2 }}</td>
            <td>{{ entry.height2 }}</td>
            <td>{{ entry.length_or_radius }}</td>
            <td>{{ entry.quantity }}</td>
            <td>{{ entry.degree_or_offset }}</td>
            <td>{{ entry.gauge }}</td>
            <td>{{ entry.area }}</td>
            <td>{{ entry.nuts_bolts }}</td>
            <td>{{ entry.cleat }}</td>
            <td>{{ entry.gasket }}</td>
            <td>{{ entry.corner_pieces }}</td>
            <td>
              <a href="/edit/{{ entry.id }}" class="btn btn-sm btn-warning">âœï¸</a>
              <a href="/delete/{{ entry.id }}" class="btn btn-sm btn-danger">ğŸ—‘ï¸</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- âœ… EXPORT + SUBMIT ALL -->
  <div class="mt-3 d-flex gap-2">
    <a href="/export_excel/{{ project.id }}" class="btn btn-outline-primary">ğŸ“¤ Export Excel</a>
    <a href="/export_pdf/{{ project.id }}" class="btn btn-outline-secondary">ğŸ§¾ Export PDF</a>
    <form method="POST" action="/submit_all/{{ project.id }}">
      <button class="btn btn-success">ğŸ“¨ Submit All</button>
    </form>
  </div>
  {% endif %}

</div>

<!-- âœ… MODAL: ADD PROJECT -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="/create_project" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">â• Add New Project</h5></div>
        <div class="modal-body row g-3 px-4 py-2">
          <div class="col-md-6">
            <label>Vendor</label>
            <select id="vendorSelect" name="vendor_id" class="form-select" required>
              <option value="">Select Vendor</option>
              {% for vendor in vendors %}
              <option value="{{ vendor.id }}" data-address="{{ vendor.address }}" data-gst="{{ vendor.gst }}">{{ vendor.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label>Project Name</label>
            <input name="project_name" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label>Enquiry ID</label>
            <input name="enquiry_no" value="{{ enquiry_id }}" class="form-control" readonly>
          </div>
          <div class="col-md-6">
            <label>Start Date</label>
            <input type="date" name="start_date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label>End Date</label>
            <input type="date" name="end_date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label>Drawing Upload</label>
            <input type="file" name="drawing_file" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Project Incharge</label>
            <input name="incharge" class="form-control">
          </div>
          <div class="col-md-6">
            <label>Notes</label>
            <textarea name="notes" rows="2" class="form-control"></textarea>
          </div>
          <div class="col-md-6">
            <label>Vendor GST</label>
            <input id="vendorGst" class="form-control" readonly>
          </div>
          <div class="col-md-6">
            <label>Vendor Address</label>
            <textarea id="vendorAddress" class="form-control" rows="2" readonly></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">âœ… Save Project</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒ Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- âœ… MODAL: MEASUREMENT SHEET (used in preparation status) -->
<div class="modal fade" id="measurementSheetModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <form method="POST" action="/add_duct">
      <input type="hidden" name="project_id" value="{{ project.id }}">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">ğŸ“ Measurement Sheet Entry</h5></div>
        <div class="modal-body">
          <!-- Duct Entry form fields go here (duct_no, type, dimensions...) -->
          <div class="row g-3">
            <div class="col-md-4"><label>Duct No</label><input name="duct_no" class="form-control" required></div>
            <div class="col-md-4"><label>Type</label><input name="duct_type" class="form-control" required></div>
            <div class="col-md-4"><label>Factor</label><input name="factor" class="form-control"></div>

            <div class="col-md-2"><label>W1</label><input name="width1" class="form-control"></div>
            <div class="col-md-2"><label>H1</label><input name="height1" class="form-control"></div>
            <div class="col-md-2"><label>W2</label><input name="width2" class="form-control"></div>
            <div class="col-md-2"><label>H2</label><input name="height2" class="form-control"></div>
            <div class="col-md-2"><label>Length/Radius</label><input name="length_or_radius" class="form-control"></div>
            <div class="col-md-2"><label>Qty</label><input name="quantity" class="form-control"></div>
            <div class="col-md-2"><label>Degree/Offset</label><input name="degree_or_offset" class="form-control"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">â• Add Entry</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

  {% if project and project.status == 'preparation' %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var modal = new bootstrap.Modal(document.getElementById('measurementSheetModal'));
    modal.show();
  });
</script>
{% endif %}
{% if project.status == 'preparation' %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var modal = new bootstrap.Modal(document.getElementById('measurementSheetModal'));
    modal.show();
  });
{% if project.status == 'preparation' %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var modal = new bootstrap.Modal(document.getElementById('measurementSheetModal'));
    modal.show();
  });
</script>
<!-- You probably forgot this line -->
{% endif %}

</body>
</html>
